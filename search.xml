<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>闲置的手机可以这样玩</title>
      <link href="2021/04/14/mobile/"/>
      <url>2021/04/14/mobile/</url>
      
        <content type="html"><![CDATA[<blockquote><p>现在的家里，谁还没有几个旧手机啊，可是旧手机用吧，不想用，扔了吧又可惜。换不锈钢脸盆吧，又怕信息泄露。今天咱就把这个闲置的手机利用其起来。</p></blockquote><h3 id="0-准备工作"><a href="#0-准备工作" class="headerlink" title="0.准备工作"></a>0.准备工作</h3><hr><p>首先得下载个软件，名字叫 <strong>IP 摄像头</strong> 找找，应该挺多的。我用的是下面图标的软件</p><p><img src="/img/20210414/tubiao.png" alt="软件图标"></p><p>我用的是免费版的，监控是够了。</p><p><img src="/img/20210414/jietu0.jpg" alt="软件截图"></p><p>打开软件，点击下方的打开IP摄像头服务器就行了，在新的页面上有浏览的地址，在浏览上输入地址就能够看到图像了。</p><h3 id="1-接入HA"><a href="#1-接入HA" class="headerlink" title="1.接入HA"></a>1.接入HA</h3><hr><p>接入HA很简单，照着下面配置一下就行，信息在打开服务器后会在下方显示的。用提供的信息填写完整就行。用户名密码是自己设的。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">android_ip_webcam</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> 手机的IP地址    <span class="token key atrule">port</span><span class="token punctuation">:</span> 端口    <span class="token key atrule">name</span><span class="token punctuation">:</span> IPCam0    <span class="token key atrule">username</span><span class="token punctuation">:</span> 用户名    <span class="token key atrule">password</span><span class="token punctuation">:</span> 密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启一下HA，在页面上添加一下这个传感器。如果要实现实时预览，可以使用 picture-entity 这个卡片，设置如下</p><p><img src="/img/20210414/jietu1.png" alt="软件截图"></p><p>记得要选上live哦，到此HA接入完毕</p><h3 id="2-接入HB"><a href="#2-接入HB" class="headerlink" title="2.接入HB"></a>2.接入HB</h3><hr><p>我在群晖上用docker搭了个HB，所以自然也想接入他，接入之后就可以使用苹果的家庭查看录像了。搭建HB的教程网上有的，这里就不介绍了。说一下我当时接入的坑吧。我的HB搭建的有点早了，nodejs的版本还很低的，导致我装插件装了半天都不行，换了好几个平台都没用，后面拉了一个新的镜像就行了，所以建议大家还是拉取最新的镜像吧。这是<a href="https://www.npmjs.com/package/homebridge-ip-camera">插件的介绍页</a>大家可以参考着配置和安装。给大家看看我的配置</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>         <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token string">"Camera-IP"</span><span class="token punctuation">,</span>         <span class="token property">"cameras"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>               <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"My Camera"</span><span class="token punctuation">,</span>               <span class="token property">"videoConfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                   <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"-re -i http://username:password@IP:PORT"</span><span class="token punctuation">,</span>                   <span class="token property">"maxStreams"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                   <span class="token property">"maxWidth"</span><span class="token operator">:</span> <span class="token number">1280</span><span class="token punctuation">,</span>                   <span class="token property">"maxHeight"</span><span class="token operator">:</span> <span class="token number">720</span><span class="token punctuation">,</span>                   <span class="token property">"maxFPS"</span><span class="token operator">:</span> <span class="token number">60</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>               <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"My Camera0"</span><span class="token punctuation">,</span>               <span class="token property">"videoConfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                   <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"-re -i http://username:password@IP:PORT"</span><span class="token punctuation">,</span>                   <span class="token property">"maxStreams"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                   <span class="token property">"maxWidth"</span><span class="token operator">:</span> <span class="token number">1280</span><span class="token punctuation">,</span>                   <span class="token property">"maxHeight"</span><span class="token operator">:</span> <span class="token number">720</span><span class="token punctuation">,</span>                   <span class="token property">"maxFPS"</span><span class="token operator">:</span> <span class="token number">60</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">]</span>      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启之后用苹果家庭添加新设备就行了。</p><p>看看接入后的效果：</p><p><img src="/img/20210414/jietu2.jpg" alt="接入截图"></p><h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h3><hr><p>如果要一直能看到的话，就得一直开着手机才行的。可能有点费电，但是手机还是发挥了他的余热。家里的已经做了内网穿透，HA可以外网访问，在其中的摄像头自然也可以外网访问了。HB的话需要家里有一个IPad，HomePod或者其他支持的设备作为家庭中枢，就可以在外面也可以访问了。还是很棒的。</p>]]></content>
      
      
      <categories>
          
          <category> 智能家居 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HA </tag>
            
            <tag> 闲置利用 </tag>
            
            <tag> 摄像头 </tag>
            
            <tag> HB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HA中燃插件</title>
      <link href="2021/04/13/gas/"/>
      <url>2021/04/13/gas/</url>
      
        <content type="html"><![CDATA[<blockquote><p>这是中燃的燃气插件，抓包后的api还是比较友好的</p></blockquote><h3 id="0-抓包"><a href="#0-抓包" class="headerlink" title="0.抓包"></a>0.抓包</h3><hr><p>按照国际惯例，首先抓包。从小程序入手，微信搜索 <strong>中燃慧生活</strong> 。然后打开抓包工具，开始抓包即可</p><h3 id="1-分析抓包数据"><a href="#1-分析抓包数据" class="headerlink" title="1.分析抓包数据"></a>1.分析抓包数据</h3><hr><p>中燃的接口还是挺友好的，都是json格式的。查看抓包的数据，找到这么一个地址 <strong><a href="https://zrds.zrhsh.com/controller/payfee/getcustomerMoneyListForMp.do">https://zrds.zrhsh.com/controller/payfee/getcustomerMoneyListForMp.do</a></strong> ，这个地址里面有咱想要的数据。数据咱就不贴了，都是看的到的。</p><h3 id="2-开发插件"><a href="#2-开发插件" class="headerlink" title="2.开发插件"></a>2.开发插件</h3><hr><p>分析数据，插件代码如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""Support for zhongran gas# Author:    freefitter# Created:    2020/9/2"""</span><span class="token keyword">import</span> logging<span class="token keyword">import</span> json<span class="token keyword">import</span> datetime<span class="token keyword">from</span> dateutil<span class="token punctuation">.</span>relativedelta <span class="token keyword">import</span> relativedelta <span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>const <span class="token keyword">import</span> <span class="token punctuation">(</span>    CONF_API_KEY<span class="token punctuation">,</span> CONF_NAME<span class="token punctuation">,</span> ATTR_ATTRIBUTION<span class="token punctuation">,</span> CONF_ID    <span class="token punctuation">)</span><span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span>entity <span class="token keyword">import</span> Entity<span class="token keyword">import</span> homeassistant<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span>config_validation <span class="token keyword">as</span> cv<span class="token keyword">import</span> voluptuous <span class="token keyword">as</span> vol<span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>components<span class="token punctuation">.</span>sensor <span class="token keyword">import</span> PLATFORM_SCHEMA<span class="token keyword">import</span> requests<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup_Log<span class="token operator">=</span>logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>DEFAULT_NAME <span class="token operator">=</span> <span class="token string">'zrgas'</span>CUSTCODE <span class="token operator">=</span> <span class="token string">'custCode'</span>PLATFORM_SCHEMA <span class="token operator">=</span> PLATFORM_SCHEMA<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">{</span>    vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>CUSTCODE<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>    vol<span class="token punctuation">.</span>Optional<span class="token punctuation">(</span>CONF_NAME<span class="token punctuation">,</span> default<span class="token operator">=</span> DEFAULT_NAME<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>HEADERS <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>    <span class="token string">'Upgrade-Insecure-Requests'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>    <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span><span class="token punctuation">,</span>    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (iPhone; CPU iPhone OS 12_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/WIFI Language/zh_CN'</span><span class="token punctuation">}</span>API_URL <span class="token operator">=</span> <span class="token string">"https://zrds.zrhsh.com/controller/payfee/getcustomerMoneyListForMp.do"</span><span class="token keyword">def</span> <span class="token function">setup_platform</span><span class="token punctuation">(</span>hass<span class="token punctuation">,</span> config<span class="token punctuation">,</span> add_devices<span class="token punctuation">,</span> discovery_info<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    custCode <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>CUSTCODE<span class="token punctuation">)</span>    sensor_name <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>CONF_NAME<span class="token punctuation">)</span>    today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>    current_month <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>today<span class="token punctuation">,</span> <span class="token string">"%Y%m"</span><span class="token punctuation">)</span>            last_2_month <span class="token operator">=</span> today <span class="token operator">+</span> relativedelta<span class="token punctuation">(</span>months<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>    last_two_month <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>last_2_month<span class="token punctuation">,</span> <span class="token string">"%Y%m"</span><span class="token punctuation">)</span>        data_dict <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'custCode'</span><span class="token punctuation">:</span> custCode<span class="token punctuation">,</span>        <span class="token string">'envir'</span><span class="token punctuation">:</span><span class="token string">'2'</span><span class="token punctuation">,</span>        <span class="token string">'startTime'</span><span class="token punctuation">:</span>last_two_month<span class="token punctuation">,</span>        <span class="token string">'endTime'</span><span class="token punctuation">:</span>current_month<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    add_devices<span class="token punctuation">(</span><span class="token punctuation">[</span>ZRGas<span class="token punctuation">(</span>sensor_name<span class="token punctuation">,</span>data_dict<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">ZRGas</span><span class="token punctuation">(</span>Entity<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Representation of a Nanjing water """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>sensor_name<span class="token punctuation">,</span>data_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>attributes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        self<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token boolean">None</span>        self<span class="token punctuation">.</span>_data_dict <span class="token operator">=</span> data_dict        self<span class="token punctuation">.</span>_name <span class="token operator">=</span> sensor_name    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the name of the sensor."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_name    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the state of the sensor."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_state    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">icon</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""返回mdi图标."""</span>        <span class="token keyword">return</span> <span class="token string">'mdi:fire'</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">device_state_attributes</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the state attributes."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>attributes    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">unit_of_measurement</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the unit this state is expressed in."""</span>        <span class="token keyword">return</span> <span class="token string">"元"</span>    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>API_URL<span class="token punctuation">,</span>params<span class="token operator">=</span>self<span class="token punctuation">.</span>_data_dict<span class="token punctuation">,</span>headers <span class="token operator">=</span> HEADERS<span class="token punctuation">)</span>        <span class="token keyword">except</span> ReadTimeout<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Connection timeout...."</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> ConnectionError<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Connection Error...."</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> RequestException<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Unknown Error"</span><span class="token punctuation">)</span>        res <span class="token operator">=</span> response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>        ret <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>res<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_state <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"receivable"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'recordMonth'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"recordMonth"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'curRecord'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"curRecord"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'curQty'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"curQty"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'balance'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">]</span>         self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'received'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"received"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'laterFee'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"laterFee"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'lastRecord'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"lastRecord"</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'timeCurRecord'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"payGasCheckList"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"timeCurRecord"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-配置HA"><a href="#4-配置HA" class="headerlink" title="4.配置HA"></a>4.配置HA</h3><hr><p>插件需要客户号，上面抓包的请求就有，拿就完事了。接着照着下面配置就行。配置完成后，重启HA就行了</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">platform</span><span class="token punctuation">:</span> zrgas    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'燃气费'</span>    <span class="token key atrule">custCode</span><span class="token punctuation">:</span> <span class="token string">'XXXXXXX'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="5-成果展示"><a href="#5-成果展示" class="headerlink" title="5.成果展示"></a>5.成果展示</h3><p><img src="/img/20210413/gas.jpg" alt="插件展示"></p><p>至此，家里的水电燃气已经接入完毕，后面再把其他的整理整理，分享出来。</p>]]></content>
      
      
      <categories>
          
          <category> 智能家居 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HA </tag>
            
            <tag> python </tag>
            
            <tag> 插件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>周末记事</title>
      <link href="2021/04/12/dayshare21412/"/>
      <url>2021/04/12/dayshare21412/</url>
      
        <content type="html"><![CDATA[<blockquote><p>又是一个平常的周末，周末就该带娃，遛娃，多图和视频预警</p></blockquote><h3 id="0-第一天"><a href="#0-第一天" class="headerlink" title="0.第一天"></a>0.第一天</h3><p>周六是一节亲子课，9:00上课。忙忙弄弄还是迟到了一会。学习路线和往常一样，蒙氏线，然后是儿歌环节，接着是玩具的教学，最后一个大动作。这次玩具是套杯，让她感知大小。大动作是海洋球的投掷，就是将海洋球投掷过大圆环。</p><p>一开始的自我介绍，</p><p><img src="/img/20210412/1.0.jpg" alt="认真听课"></p><p>中间的玩具光陪她玩了，没拍照。大动作的时候拍了，感觉她不喜欢投掷，更喜欢大圆环本身<span class="github-emoji"><span>😂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> </p><p><img src="/img/20210412/1.1.jpg" alt="爱玩大圆环"></p><p>上课结束后要去趟江南，开车实在是堵，也不好停车，所以就准备开车去。这是小家伙第二次坐地铁。感觉比第一次好很多了。地铁上有个大哥哥给我们让了座，坐下来的彤彤还是很乖的哦。</p><p><img src="/img/20210412/1.2.jpg" alt="坐地铁的彤彤"></p><p>到了之后，妈妈去看了彤彤外婆了，我负责在楼下带着她，一开始喝着果汁，还是很乖的，果汁喝完了之后就要下来跑。下来之后，她就是脱缰的野马，四处跑，我根本无暇顾及其他，小车放在一边。下面看看跑动的彤。人像模式没P，颜值很是能打的吧，<span class="github-emoji"><span>😆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> </p><p><img src="/img/20210412/1.3.jpg" alt="跑动中的彤"></p><p>事情办完之后就去逛了逛商场。逛完之后也不早了，就在那边吃了个晚饭。下面看看神同步的眼神</p><p><img src="/img/20210412/1.4.jpg" alt="神同步"></p><p><img src="/img/20210412/1.5.jpg" alt="神同步"></p><p>今天玩得太晚了，回家澡都不愿意洗。</p><h3 id="1-第二天"><a href="#1-第二天" class="headerlink" title="1.第二天"></a>1.第二天</h3><p>周日是感统课，早上起来之后带她玩玩给他弄个午饭，睡个午觉就出发了。这次没迟到，早早到了。今天的感统课是锻炼手臂力量。还是套圈，走玻璃的斜坡，蹦床，之后就是爬滚筒。这次的感统课彤彤表现的都很好，很多能够自己独立完成。完成大游戏之后就是泡泡环节，希望他们能够用自己的一根手指头去接住泡泡，锻炼他们的五指分化能力。</p><p><img src="/img/20210412/2.0.jpg" alt="套圈的小姑娘"></p><p><img src="/img/20210412/2.1.jpg" alt="走玻璃"></p><p><img src="/img/20210412/2.2.jpg" alt="开心的泡泡环节"></p><p><img src="/img/20210412/2.3.jpg" alt="开心的泡泡环节"></p><p>下面是魔性的live抓泡泡</p><p><video src="/img/20210412/0.MOV" controls="controls" width="100%" muted="" autoplay="true" loop="loop"></video></p><p><video src="/img/20210412/1.MOV" controls="controls" width="100%" muted="" autoplay="true" loop="loop"></video></p><p><video src="/img/20210412/2.MOV" controls="controls" width="100%" muted="" autoplay="true" loop="loop"></video></p><h3 id="3-结语"><a href="#3-结语" class="headerlink" title="3.结语"></a>3.结语</h3><p>周末还是很充实的，彤彤现在越来越厉害了。不要一成不变，要变得更好。加油！</p>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 宝宝 </tag>
            
            <tag> 早教 </tag>
            
            <tag> 周末 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>收藏网站列表</title>
      <link href="2021/04/09/urlLists/"/>
      <url>2021/04/09/urlLists/</url>
      
        <content type="html"><![CDATA[<h3 id="0-素材类网址"><a href="#0-素材类网址" class="headerlink" title="0.素材类网址"></a>0.素材类网址</h3><ul><li><a href="https://www.pexels.com/zh-cn/">免费素材图片</a></li><li><a href="https://www.flaticon.com/">免费SVG图标</a></li><li><a href="http://tool.c7sky.com/webcolor/">网页设计常用色彩搭配表</a></li><li><a href="https://www.17sucai.com/">17素材网</a></li></ul><h3 id="1-工具类网站"><a href="#1-工具类网站" class="headerlink" title="1.工具类网站"></a>1.工具类网站</h3><ul><li><a href="http://www.bejson.com/jsoneditoronline/">JSON在线编辑器</a></li><li><a href="https://picsvg.com/">免费SVG转换</a></li><li><a href="http://playground.tensorflow.org/">神经网络</a></li></ul><h3 id="2-免费API"><a href="#2-免费API" class="headerlink" title="2.免费API"></a>2.免费API</h3><ul><li><a href="http://zhwnlapi.etouch.cn/Ecalender/api/v2/weather?citykey=101190101">华风新天气API</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 备忘 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网址 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MQTT,Node-RED初探</title>
      <link href="2021/04/08/mqttsensor/"/>
      <url>2021/04/08/mqttsensor/</url>
      
        <content type="html"><![CDATA[<h3 id="0-简介"><a href="#0-简介" class="headerlink" title="0.简介"></a>0.简介</h3><hr><p>MQTT 简介</p><blockquote><p>MQTT(消息队列遥测传输)是ISO 标准(ISO/IEC PRF 20922)下基于发布/订阅范式的消息协议。它工作在 TCP/IP协议族上，是为硬件性能低下的远程设备以及网络状况糟糕的情况下而设计的发布/订阅型消息协议，为此，它需要一个消息中间件 。<br>MQTT是一个基于客户端-服务器的消息发布/订阅传输协议。MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。其在，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中已广泛使用。</p></blockquote><p>Node-RED简介</p><blockquote><p>Node-RED是一款基于NodeJS的构建物联网应用程序的强大工具,其重点是简化代码块的“连接”以执行任务。它使用可视化编程方法，允许开发人员将预定义的代码块（称为“节点”，Node）连接起来执行任务。连接的节点，通常是输入节点、处理节点和输出节点的组合，当它们连接在一起时，构成一个“流”(Flows)。<br>Node-RED最初是IBM在2013年末开发的一个开源项目，以满足他们快速连接硬件和设备到Web服务和其他软件的需求——作为物联网的一种粘合剂，它很快发展成为一种通用的物联网编程工具。重要的是，Node-RED已经迅速形成一个重要的、不断增长的用户基础和一个活跃的开发人员社区，他们正在开发新的节点，同时允许程序员复用Node-RED代码来完成各种各样的任务。</p></blockquote><h3 id="1-配置HA中的MQTT"><a href="#1-配置HA中的MQTT" class="headerlink" title="1.配置HA中的MQTT"></a>1.配置HA中的MQTT</h3><hr><p>在 <strong>configuration.yaml</strong> 中配置如下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">mqtt</span><span class="token punctuation">:</span>  <span class="token key atrule">discovery</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">discovery_prefix</span><span class="token punctuation">:</span> homeassistant  <span class="token key atrule">password</span><span class="token punctuation">:</span> XXXXXXX<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>具体配置可以参看 <a href="https://www.home-assistant.io/docs/mqtt/">官方文档</a> 。 重启HA就可以了。</p><h3 id="2-配置Node-RED"><a href="#2-配置Node-RED" class="headerlink" title="2.配置Node-RED"></a>2.配置Node-RED</h3><hr><p>自己安装下Node-Red。我是在群晖docker里面装的，<a href="https://registry.hub.docker.com/r/nodered/node-red-docker/">镜像说明</a> 是这个。这边是网上的<a href="https://www.feeus.com/%E7%BE%A4%E6%99%96%E4%BD%BF%E7%94%A8docker%E5%AE%89%E8%A3%85node-red/">安装教程</a>可以参照着安装</p><p>安装好了浏览器输入 <a href="http://192.168.xxx.xxx:1880/">http://192.168.XXX.XXX:1880/</a> 就可以看到界面了。</p><p><img src="/img/20210408/nodered.png" alt="Node-RED界面"></p><p>配置broker，输入MQTT的IP和端口，上面配置了密码，所以安全中要输入下</p><p><img src="/img/20210408/mqtt0.png" alt="MQTT配置"></p><p><img src="/img/20210408/mqtt1.png" alt="MQTT配置"></p><p>配置完了就可以使用了。</p><h3 id="3-给传感器注入灵魂"><a href="#3-给传感器注入灵魂" class="headerlink" title="3.给传感器注入灵魂"></a>3.给传感器注入灵魂</h3><hr><p>按照图示拖拽相关的节点</p><p><img src="/img/20210408/flow.jpg" alt="流"></p><p>下面以微博热搜为例</p><p><a href="https://s.weibo.com/ajax/jsonp/gettopsug?uid=&amp;ref=PC_topsug&amp;url=https://s.weibo.com/weibo/%2525E7%2525BC%252585%2525E7%252594%2525B8%2525E4%2525BB%2525B0%2525E5%252585%252589%2525E9%252583%2525A8%2525E5%252588%252586%2525E5%25259C%2525B0%2525E5%25258C%2525BA%2525E5%2525AE%25259E%2525E6%252596%2525BD%2525E5%252586%25259B%2525E4%2525BA%25258B%2525E7%2525AE%2525A1%2525E5%252588%2525B6?topnav=1&amp;wvr=6&amp;Refer=top_button&amp;Mozilla=Mozilla/5.0%20(Windows%20NT%2010.0;%20Win64;%20x64)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20Chrome/89.0.4389.82%20Safari/537.36&amp;_cb=STK_16157756566583">热搜接口地址</a> 通过Get请求到相关数据。数据不是Json格式的，需要转化</p><p>转化方法如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> respText <span class="token operator">=</span> msg<span class="token punctuation">.</span>payload<span class="token punctuation">;</span><span class="token keyword">var</span> str <span class="token operator">=</span> respText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"try{window.STK_16157756566583&amp;STK_16157756566583("</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">")}catch(e){}"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>payload <span class="token operator">=</span> str<span class="token keyword">return</span> msg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注册传感器数据如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">msg<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>    unique_id<span class="token operator">:</span> <span class="token string">"HA-sensor_wbhot"</span><span class="token punctuation">,</span>    name<span class="token operator">:</span> <span class="token string">"wbhot"</span><span class="token punctuation">,</span>    icon<span class="token operator">:</span> <span class="token string">"mdi:sina-weibo"</span><span class="token punctuation">,</span>    state_topic<span class="token operator">:</span> <span class="token string">"device20210312/sensor_wbhot/state"</span><span class="token punctuation">,</span>    json_attributes_topic<span class="token operator">:</span> <span class="token string">"device20210312/sensor_wbhot/attributes"</span><span class="token punctuation">,</span>    unit_of_measurement<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    device<span class="token operator">:</span> <span class="token punctuation">{</span>        identifiers<span class="token operator">:</span> <span class="token string">"20210312"</span><span class="token punctuation">,</span>        manufacturer<span class="token operator">:</span> <span class="token string">"MQTT_Sensor"</span><span class="token punctuation">,</span>        model<span class="token operator">:</span> <span class="token string">"HA"</span><span class="token punctuation">,</span>        name<span class="token operator">:</span> <span class="token string">"微博热搜"</span><span class="token punctuation">,</span>        sw_version<span class="token operator">:</span> <span class="token string">"1.0"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> msg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注册状态数据如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">note <span class="token operator">=</span> msg<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>notemsg<span class="token punctuation">.</span>payload <span class="token operator">=</span> note<span class="token keyword">return</span> msg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>注册属性数据如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> jsonArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> dataList <span class="token operator">=</span> msg<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>list<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token keyword">var</span> jsObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    jsObj<span class="token punctuation">.</span>name <span class="token operator">=</span> dataList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>note<span class="token punctuation">;</span>    jsObj<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">"https://s.weibo.com/weibo?q=%23"</span> <span class="token operator">+</span> dataList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>note <span class="token operator">+</span> <span class="token string">"%23&amp;Refer=top"</span><span class="token punctuation">;</span>    jsObj<span class="token punctuation">.</span>num <span class="token operator">=</span> dataList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>num    jsonArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>jsObj<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">var</span> retList <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>retList<span class="token punctuation">.</span>lists <span class="token operator">=</span> jsonArraymsg<span class="token punctuation">.</span>payload <span class="token operator">=</span> retList<span class="token punctuation">;</span><span class="token keyword">return</span> msg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>属性数据用的是Json对象，以便后面展示用。当然也可以弄成字符串，自由发挥。</p><h3 id="4-效果展示"><a href="#4-效果展示" class="headerlink" title="4.效果展示"></a>4.效果展示</h3><hr><p>展示界面比较简陋，用的vue，之前已经放过结果图了。数据是通过HA的api来获取的。界面就不贴了，太简陋。脚本如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span><span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>info<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>lists<span class="token operator">:</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/states/sensor.wbhot'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  headers <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">'Authorization'</span><span class="token operator">:</span> <span class="token string">"Bearer XXXXXXXX"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>lists <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>lists<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再盗用下之前的图吧</p><p><img src="/img/20210406/info.png" alt="MQTT插件展示"></p>]]></content>
      
      
      <categories>
          
          <category> 智能家居 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HA </tag>
            
            <tag> mqtt </tag>
            
            <tag> Node-red </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Scratch飞花令</title>
      <link href="2021/04/07/fhl/"/>
      <url>2021/04/07/fhl/</url>
      
        <content type="html"><![CDATA[<blockquote><p>这是一个Scratch的飞花令教程</p></blockquote><h3 id="0-背景"><a href="#0-背景" class="headerlink" title="0.背景"></a>0.背景</h3><hr><p>老婆的学校有个教学短视频制作的比赛，她不知道做什么，我就提议将编程和教学联合起来。小学生现在都流行图形化编程，Scratch就是其中一个，所以我就想把这两个结合起来，做个东西。</p><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><hr><p>下面是飞花令和Scratch的简介</p><blockquote><p>飞花令，原本是古人行酒令时的一个文字游戏，源自古人的诗词之趣，得名于唐代诗人韩翃《寒食》中的名句“春城无处不飞花”。行飞花令时可选用诗词曲中的句子，但选择的句子一般不超过七个字。</p></blockquote><blockquote><p>Scratch是麻省理工学院的“终身幼儿园团队”开发的图形化编程工具，主要面对青少年开放。</p></blockquote><h3 id="2-制作过程"><a href="#2-制作过程" class="headerlink" title="2.制作过程"></a>2.制作过程</h3><hr><p><img src="/img/20210407/fhl0.jpg" alt="飞花令"></p><p><img src="/img/20210407/fhl1.jpg" alt="飞花令"></p><p><img src="/img/20210407/fhl2.jpg" alt="飞花令"></p><p><img src="/img/20210407/fhl3.jpg" alt="飞花令"></p><h3 id="3-成果展示"><a href="#3-成果展示" class="headerlink" title="3.成果展示"></a>3.成果展示</h3><hr><p><video src="/img/20210407/fhl.mp4" width="100%" controls="controls"></video></p><h3 id="4-比赛结果"><a href="#4-比赛结果" class="headerlink" title="4.比赛结果"></a>4.比赛结果</h3><hr><p>这次比赛获得了精品作品奖</p><p><img src="/img/20210407/zs.png" alt="荣誉证书"></p><p>还是不错的，以后继续加油吧!</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Scratch </tag>
            
            <tag> 编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生活记事</title>
      <link href="2021/04/07/life-20210407/"/>
      <url>2021/04/07/life-20210407/</url>
      
        <content type="html"><![CDATA[<h3 id="0-照片分享"><a href="#0-照片分享" class="headerlink" title="0.照片分享"></a>0.照片分享</h3><hr><p>下班后彤彤就到小区门口接我们，接着去拿了个快递。以下是彤妈拍的漂亮彤</p><p><img src="/img/20210407/0.jpg" alt="漂亮可爱的宝宝"></p><p><img src="/img/20210407/1.jpg" alt="漂亮可爱的宝宝"></p><p><img src="/img/20210407/2.jpg" alt="漂亮可爱的宝宝"></p><h3 id="1-说在最后"><a href="#1-说在最后" class="headerlink" title="1.说在最后"></a>1.说在最后</h3><hr><p>小孩的魔力真的很大，很能感染你。家人可能会为了宝宝的成长有些许分歧，但是目标总是希望她健康快乐成长。生活就是这样，好好享受这个过程。</p>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 宝宝 </tag>
            
            <tag> 照片 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>交易制作工具</title>
      <link href="2021/04/07/maketranstool/"/>
      <url>2021/04/07/maketranstool/</url>
      
        <content type="html"><![CDATA[<h3 id="0-工具简介"><a href="#0-工具简介" class="headerlink" title="0.工具简介"></a>0.工具简介</h3><hr><p>由于开发交易是固定繁琐的动作，所以想开发一款交易制作工具来达到提高生产力。有更多的时间去做更有意义的事情。工具定制性比较强，可能都不能用。但是可以共享其中的想法和思路。是18年写的，也运行了几年了，没出什么大问题，运行还算稳定。小工具采用VBS编码，比较轻便，能够在Windows平台下顺利运行，也不占用系统空间。这个小程序主要使用了 模拟POST请求，使用Sqlplus和数据库进行交互，xml文件解析和文件的读写操作以及移动。代码不是很复杂</p><h3 id="1-目录结构"><a href="#1-目录结构" class="headerlink" title="1.目录结构"></a>1.目录结构</h3><hr><p>|   MakeTrans.vbs     —&gt;  小工具的运行程序,双击即可运行<br>|<br>|   CheckIsValid.vbs  —&gt;  检查XML报文是否合法[要在文件都修改完成后检测]<br>|<br>+—Log                       —&gt;  日志输出文件夹<br>|       Run-[20180417092345].log        —&gt;   日志文件<br>|    Script.log            —&gt;   协议相关脚本<br>|<br>+—traninfo.txt      —&gt;  交易粘贴处<br>|<br>+—Metadata          —&gt;  元数据输出文件夹<br>|       3001300000333-metadata.zip      —&gt;   元数据文件<br>|       service       —&gt;  模板修改后的文件会出现在这个文件夹下<br>|<br>+—Template          —&gt;  模板文件夹<br>|       BIBPS.xml     —&gt;  会将拆组报文件中的Body内的内容替换模板中的 XXXXXXXXXXXXXXXXXXXX 内容<br>|<br>+—Tmp                                 —&gt;  临时文件夹[用于存储从SVN中拷贝过来的文件]<br>|       metadata.xml             —&gt;  修改的元数据文件<br>|       serviceIdentify.xml    —&gt;  修后的服务识别文件<br>|       systemIdentify.xml    —&gt;  修改后的系统识别<br>|<br>-–SQLScript                               —&gt;  工具中用到的SQL脚本文件夹[勿删勿改]<br>        CheckTran.sql                   —&gt;   检查交易是否为存量脚本<br>        GetInfo.sql                         —&gt;   获得下载Metadata的参数<br>        GetName.sql                     —&gt;   获得系统名对应的简称<br>        AddChannel.sql                —&gt;   添加新增渠道<br>        AddSystem.sql                  —&gt;   添加新增系统方<br>        GetCHName.sql                —&gt;   获得中文描述</p><h3 id="2-功能介绍"><a href="#2-功能介绍" class="headerlink" title="2.功能介绍"></a>2.功能介绍</h3><hr><p><strong>0、 更新SVN[需要安装svn命令行]<br>1、 登录服务治理平台下载脚本以及配置文件<br>2、 将下载好的脚本入库<br>3、 检查交易的类型[存量或者新增]<br>4、 将配置文件拷贝至本地SVN[根据交易类型进行拷贝]<br>5、 比对元数据并修改<br>6、 修改公共文件[服务识别，系统识别]<br>7、 根据模板文件修改拆组包报文<br>8、 增加XML可用性检测[由于多次出现低级错误，故添加]<br>9、 可选择执行的步骤</strong></p><h3 id="3-常见问题"><a href="#3-常见问题" class="headerlink" title="3.常见问题"></a>3.常见问题</h3><hr><p>Q：换到其他机器上时出现错误，原因是sqlplus连接出现乱码<br>A：可以使用 echo %NLS_LANG% 查看，并配置该环境变量<br>    C:\Users\XXXXX&gt;echo %NLS_LANG%<br>    AMERICAN_AMERICA.ZHS32GB18030</p><p>Q: 出现 BComp.exe 不是命令<br>A: 使用BCompare工具时需要添加环境变量</p><p>Q: 出现不能解压文件时<br>A: 需要将winrar加入环境变量</p><h3 id="4-代码展示"><a href="#4-代码展示" class="headerlink" title="4.代码展示"></a>4.代码展示</h3><hr><pre class="line-numbers language-vbscript" data-language="vbscript"><code class="language-vbscript">'Author:wangxingyang'Date:20180413'write at nanjing bankSet http=CreateObject("MSXML2.XMLHTTP")Set html = CreateObject("htmlfile")Set wshshell = CreateObject("wscript.shell")Set xdoc = CreateObject("MSXML2.DOMDocument")Set logfso = CreateObject("Scripting.FileSystemObject")Set tranfso = CreateObject("Scripting.FileSystemObject")Set scriptfdo = CreateObject("Scripting.FileSystemObject")Set attrDict = CreateObject("Scripting.Dictionary")nowdate = Now()nowdate = Year(nowdate) &amp; Right("0" &amp; Month(nowdate),2)&amp; Right("0" &amp; Day(nowdate),2)&amp; Right("0" &amp; Hour(nowdate),2)&amp; Right("0" &amp; Minute(nowdate),2)&amp;  Right("0" &amp; Second(nowdate),2)logpath = "Log/Run-[" &amp; nowdate &amp; "].log"tranpath = "Log/Tran-[" &amp; nowdate &amp; "].log"scriptpath1 = "Log/Script.log"Set logfile = logfso.CreateTextFile(logpath,True)Set tranfile = tranfso.CreateTextFile(tranpath,True)Set scriptfile = scriptfdo.CreateTextFile(scriptpath1,True)Dim cookies'---------服务治理控制台地址----------- [ 注意:需要斜杠 ]mainurl = "http://159.1.XXX.XXX:PPPP/"'---------跑库的连接地址---------------linkurl33 = "XXXX/XXXX@159.1.XX.XXX:PPPP/RFRFR"linkurl39 = "XXXX/XXXXX@159.1.XX.XXX:PPPP/DEDEE"'---------服务治理库地址---------------serviceurl = "SSS/SSS@159.1.XX.XXX:PPPP/SESES"'---------生成临时文件----------------- [ 注意:需要斜杠 ]commpath = "Tmp\"'---------脚本存放目录----------------- [ 注意:需要斜杠 ]scriptpath = "SQLScript\"'---------元数据存放目录--------------- [ 注意:需要斜杠 ]metadatapath = "Metadata\"'---------svn metadata-----------------'---------svn路径----------------------svnpath = "Z:\WorkSpace\SmartESB\configs"inconfpath = svnpath &amp; "\in_conf\"outconfpath = svnpath &amp; "\out_conf\"svndestin = inconfpath &amp; "metadata\"svndestout = outconfpath &amp; "metadata\"svnmetadata = svndestin &amp; "metadata.xml"'---------服务定义文件-----------------newpath = "C:\Users\WWW\Desktop\交易制作工具\Metadata\"'存放数据字典中所有字段名称alldata = ""'存放需要增加的语句allNewData = ""'----------是否为存量交易标识-----------'True  存量'False 新增复用isExistFlag = True  totalNum = 0'======================='版本更新日志打印'=======================Sub versionLog()logfile.WriteLine("------------------" &amp; Now() &amp; "---------------------" &amp; Chr(13) &amp; Chr(13) &amp; Chr(13))logfile.WriteLine("=============================================================" &amp; Chr(13))logfile.WriteLine("︻┳═一 " &amp; Now() &amp; "---&gt;Author : wangxingyang")logfile.WriteLine("︻┳═一 " &amp; Now() &amp; "---&gt;Date : 2018/04/13")    logfile.WriteLine("︻┳═一 " &amp; Now() &amp; "---&gt;Contact : freefitter@163.com")logfile.WriteLine("=============================================================" &amp; Chr(13))logfile.WriteLine(Now() &amp; "---&gt;Version : v1.0 At 2018/04/13")logfile.WriteLine(Now() &amp; "---&gt;1、 检查交易是否为新增")logfile.WriteLine(Now() &amp; "---&gt;2、 导出并只执行脚本")logfile.WriteLine(Now() &amp; "---&gt;3、 导出相关配置文件")logfile.WriteLine(Now() &amp; "---&gt;4、 修改公共文件结构")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.0 At 2018/04/16")logfile.WriteLine(Now() &amp; "---&gt;1、 增加解压文件功能")logfile.WriteLine(Now() &amp; "---&gt;2、 增加比较元数据功能")logfile.WriteLine(Now() &amp; "---&gt;3、 增加拷贝至配置库功能")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.1 At 2018/05/04")logfile.WriteLine(Now() &amp; "---&gt;1、 修改弹出框BUG[弹出框有长度限制，导致处理交易报错]")logfile.WriteLine(Now() &amp; "---&gt;2、 修改文件系统名称小写问题")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.2 At 2018/05/06")logfile.WriteLine(Now() &amp; "---&gt;1、 增加交易执行判断日志")logfile.WriteLine(Now() &amp; "---&gt;2、 增加读文件进行处理交易")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.3 At 2018/05/10")logfile.WriteLine(Now() &amp; "---&gt;1、 修改元数据检查不出新增的BUG")logfile.WriteLine(Now() &amp; "---&gt;2、 修改重复添加元数据BUG")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.4 At 2018/05/14")logfile.WriteLine(Now() &amp; "---&gt;1、 修改当元数据中包含元数据时不能添加的问题")logfile.WriteLine(Now() &amp; "---&gt;2、 新增修改元数据文件功能")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.5 At 2018/05/15")logfile.WriteLine(Now() &amp; "---&gt;1、 增加文件比对功能，使用BCompare打开需要比较的工具")logfile.WriteLine(Now() &amp; "---&gt;2、 服务定义文件中，不存在的调用关系会新增")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.6 At 2018/05/17")logfile.WriteLine(Now() &amp; "---&gt;1、 新增根据交易类型判断是否跑库")logfile.WriteLine(Now() &amp; "---&gt;2、 添加交易简称查询缓存，在一次运行中相同名称值检查一次")logfile.WriteLine(Now() &amp; "---&gt;3、 新增渠道会自动新增服务识别并跑新增脚本")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.7 At 2018/05/13")logfile.WriteLine(Now() &amp; "---&gt;1、 新增根据模板替换拆组报文件功能")logfile.WriteLine(Now() &amp; "---&gt;2、 新增拼接更新适配器SQL功能")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.8 At 2018/05/30")logfile.WriteLine(Now() &amp; "---&gt;1、 新增选择执行指定流程")logfile.WriteLine(Now() &amp; "---&gt;2、 优化路径，尽量少更改路径")logfile.WriteLine(Now() &amp; "---&gt;Version : v2.9 At 2018/06/12")logfile.WriteLine(Now() &amp; "---&gt;1、 修改元数据少添加的BUG")logfile.WriteLine(Now() &amp; "---&gt;Version : v3.0 At 2018/11/15")logfile.WriteLine(Now() &amp; "---&gt;1、 修改查询元数据比对堆栈溢出BUG")logfile.WriteLine(Now() &amp; "---&gt;2、 增加粘贴格式校验")logfile.WriteLine("------------------" &amp; Now() &amp; "---------------------" &amp; vbcrlf &amp; vbcrlf)End Sub'======================='登录服务治理系统'=======================Sub login(username,password)url = mainurl &amp; "login/"http.Open "POST",url,Falsehttp.setRequestHeader "Content-Type","application/x-www-form-urlencoded; charset=UTF-8"http.Send "username=" &amp; username &amp; "&amp;password=" &amp; passwordstrHtml = http.responsetextcookies = http.getResponseHeader("Set-Cookie")logfile.WriteLine(Now() &amp; "---&gt;登录服务治理成功")End Sub'======================='检查交易是否是新增复用'=======================Sub checkTran(code,from,dest)logfile.WriteLine(Now() &amp; "---&gt;开始查看["&amp; code &amp;"]是否是全新交易")cmdstr = "sqlplus "&amp; linkurl33 &amp;" @" &amp; scriptpath &amp; "CheckTran.sql" &amp; " " &amp; codeSet exeRs = wshshell.exec(cmdstr)retmsg = exeRs.StdOut.ReadAll()logfile.WriteLine(Now() &amp; "---&gt;查询结果如下:")logfile.WriteLine(Now() &amp; "---&gt;"&amp; retmsg)If InStr(retmsg,"no rows") = 0 Thenlogfile.WriteLine(Now() &amp; "---&gt;交易[" &amp; code &amp; "]为新增复用交易!!!")fromname = queryName(from)tranfile.WriteLine("交易[" &amp; code &amp; "] ------&gt; 新增复用，调用关系为: [ " &amp; from &amp; " = " &amp; fromname &amp;" ] -&gt; " &amp; code &amp; " -&gt; [ " &amp; dest &amp; " ]")isExistFlag = TruetotalNum = totalNum + 2Elselogfile.WriteLine(Now() &amp; "---&gt;交易[" &amp; code &amp; "]为全新交易!!!")fromname = queryName(from)tranfile.WriteLine("交易[" &amp; code &amp; "] ------&gt; 全新，调用关系为: [ " &amp; from &amp; " = " &amp; fromname &amp;" ] -&gt; " &amp; code &amp; " -&gt; [ " &amp; dest &amp; " ]")isExistFlag = FalsetotalNum = totalNum + 6End Iflogfile.WriteLine(Now() &amp; "---&gt;查看["&amp; code &amp;"]是否是全新交易结束")End Sub'======================='导出并执行脚本'=======================Sub exportAndRunSQLOne(tranId)'--------导出脚本--------------'判断是否是存量，如果是存量，不用跑数据库脚本If isExistFlag Thenlogfile.WriteLine(Now() &amp; "---&gt;交易[" &amp; tranId &amp; "]为新增复用交易，不跑脚本。直接退出！")Exit SubEnd Iflogfile.WriteLine(Now() &amp; "---&gt;开始导出[" &amp; tranId &amp; "]SQL脚本")type1 = "service"operationIds = tranIdurl = mainurl &amp; "esbScriptExport/preview"http.Open "POST",url,Falsehttp.setRequestHeader "Content-Type","application/x-www-form-urlencoded; charset=UTF-8"http.setRequestHeader "Cookie",cookieshttp.Send "type=" &amp; type1 &amp; "&amp;operationIds=" &amp; operationIdsstrHtml = http.responsetextSet window = html.parentWindowwindow.execScript "var json = " &amp; strHtml, "JScript"Set ret = window.jsonsqltmp = ret.result'----------替换Adapter----------'---后期添加'------可采用先跑在更新的方式'------或者拿到后替换更新'----------写文件---------------Set fso = CreateObject("Scripting.FileSystemObject")Set file = fso.CreateTextFile( scriptpath &amp; operationIds &amp;".sql",True)file.WriteLine(sqltmp)file.WriteLine("commit;")file.WriteLine("exit;")file.close()logfile.WriteLine(Now() &amp; "---&gt;导出[" &amp; tranId &amp; "]SQL脚本完成")logfile.WriteLine(Now() &amp; "---&gt;导出内容如下：")logfile.WriteLine(Now() &amp; "---&gt; ")logfile.WriteLine(sqltmp &amp; "commit;")logfile.WriteLine(sqltmp &amp; "exit;")'-----------跑刚刚保存下来的SQL文件---------logfile.WriteLine(Now() &amp; "---&gt;在["&amp; linkurl33 &amp;"]开始执行导出脚本 " &amp; scriptpath &amp; operationIds &amp;".sql")Set exeRs = wshshell.exec("sqlplus " &amp; linkurl33 &amp;" @" &amp; scriptpath &amp; operationIds &amp;".sql")retmsg = exeRs.StdOut.ReadAll()If InStr(retmsg,"ORA") &gt; 0 Thenlogfile.WriteLine(Now() &amp; " Error-&gt;执行["&amp; tranId &amp;"]存在错误，请查看日志......")End Iflogfile.WriteLine(Now() &amp; "---&gt;拼接更新适配器语句开始..................."&amp; vbcrlf)'拼接服务场景码，用于写SQL更新sqlText = ""scriptfile.WriteLine("---" &amp; tranId)If InStr(retmsg,"BIND_PROTOCOLID_REF") &gt; 0 ThensqlText = "insert into BINDMAP(SERVICEID, STYPE, LOCATION, VERSION, PROTOCOLID, MAPTYPE) VALUES('" &amp; tranId &amp; "', 'SERVICE', 'local_out', '0', '" &amp; tranId &amp; "Adapter', 'request');" &amp; vbcrlfEnd IfsqlText = sqlText &amp; "UPDATE SERVICESYSTEMMAP SET ADAPTER = '" &amp; tranId &amp; "Adapter' WHERE SERVICEID = '" &amp; tranId &amp; "';" &amp; vbcrlfsqlText = sqlText &amp; "UPDATE BINDMAP SET PROTOCOLID = '" &amp; tranId &amp; "Adapter' WHERE SERVICEID = '" &amp; tranId &amp; "';" &amp; vbcrlfscriptfile.WriteLine(sqlText)logfile.WriteLine(sqlText)logfile.WriteLine(Now() &amp; "---&gt;拼接更新适配器语句结束..................."&amp; vbcrlf)logfile.WriteLine(Now() &amp; "---&gt;执行结果：")logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")logfile.WriteLine(retmsg)logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")logfile.WriteLine(Now() &amp; "---&gt;导出脚本执行结束 " &amp; scriptpath &amp; operationIds &amp;".sql")'-----------跑刚刚保存下来的SQL文件---------logfile.WriteLine(Now() &amp; "---&gt;在["&amp; linkurl39 &amp;"]开始执行导出脚本 " &amp; scriptpath &amp; operationIds &amp;".sql")Set exeRs = wshshell.exec("sqlplus " &amp; linkurl39 &amp;" @" &amp; scriptpath &amp; operationIds &amp;".sql")retmsg = exeRs.StdOut.ReadAll()If InStr(retmsg,"ORA") &gt; 0 Thenlogfile.WriteLine(Now() &amp; " Error-&gt;执行["&amp; tranId &amp;"]存在错误，请查看日志......")End Iflogfile.WriteLine(Now() &amp; "---&gt;执行结果：")logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")logfile.WriteLine(retmsg)logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")logfile.WriteLine(Now() &amp; "---&gt;导出脚本执行结束 " &amp; scriptpath &amp; operationIds &amp;".sql")Set sfile = fso.getfile(scriptpath &amp; operationIds &amp;".sql")sfile.deleteSet fso = NothingEnd Sub'======================='执行SQL脚本'=======================Sub RunSqlScript(en_name,ch_name,sqlname)If sqlname = "AddChannel" Thencmdstr = "sqlplus "&amp; linkurl33 &amp;" @" &amp; scriptpath &amp; sqlname &amp; ".sql" &amp; " " &amp; en_name &amp; " " &amp; en_name &amp; "Connector " &amp; ch_nameElsecmdstr = "sqlplus "&amp; linkurl33 &amp;" @" &amp; scriptpath &amp; sqlname &amp; ".sql" &amp; " " &amp; en_name &amp; " " &amp; en_name &amp; "Adapter " &amp; ch_nameEnd If'logfile.WriteLine(Now() &amp; " RunSqlScript " &amp; cmdstr)Set exeRs = wshshell.exec(cmdstr)retmsg = exeRs.StdOut.ReadAll()If InStr(retmsg,"ORA") &gt; 0 Thenlogfile.WriteLine(Now() &amp; " Error-&gt;执行新增渠道["&amp; en_name &amp;"]存在错误，请查看日志......")End Iflogfile.WriteLine(Now() &amp; "---&gt;执行结果：")logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")logfile.WriteLine(retmsg)logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")If sqlname = "AddChannel" Thencmdstr = "sqlplus "&amp; linkurl39 &amp;" @" &amp; scriptpath &amp; sqlname &amp; ".sql" &amp; " " &amp; en_name &amp; " " &amp; en_name &amp; "Connector " &amp; ch_nameElsecmdstr = "sqlplus "&amp; linkurl39 &amp;" @" &amp; scriptpath &amp; sqlname &amp; ".sql" &amp; " " &amp; en_name &amp; " " &amp; en_name &amp; "Adapter " &amp; ch_nameEnd IfSet exeRs = wshshell.exec(cmdstr)retmsg = exeRs.StdOut.ReadAll()If InStr(retmsg,"ORA") &gt; 0 Thenlogfile.WriteLine(Now() &amp; " Error-&gt;执行新增渠道["&amp; en_name &amp;"]存在错误，请查看日志......")End Iflogfile.WriteLine(Now() &amp; "---&gt;执行结果：")logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")logfile.WriteLine(retmsg)logfile.WriteLine(Now() &amp; "-----------------------------------------------------------")End Sub'======================='导出脚本并执行，支持多个'=======================Sub exportAndRunSql(tranIds)If InStr(tranIds,",") = 0  ThenexportAndRunSQLOne(tranIds)Elsemyarray = Split(tranIds,",")For i= 0 To UBound(myarray)exportAndRunSQLOne(myarray(i))nextEnd IfEnd Sub'======================='导出交易的配置文件'=======================Sub exportConf(from,dest,code)'连接数据库查询相关数据logfile.WriteLine(Now() &amp; "---&gt;准备导出配置文件")logfile.WriteLine(Now() &amp; "---&gt;查询导出配置文件所需参数")serviceId = Left(code,11)senceId = Right(code,2)cmdstr = "sqlplus "&amp; serviceurl &amp;" @" &amp; scriptpath &amp; "GetInfo.sql" &amp; " " &amp; serviceId &amp; " " &amp; senceId &amp; " " &amp; from &amp; " " &amp; destSet exeRs = wshshell.exec(cmdstr)retmsg = exeRs.StdOut.ReadAll()logfile.WriteLine(Now() &amp; "---&gt;查询导出配置文件所需参数如下:")logfile.WriteLine(Now() &amp; "---&gt;"&amp; retmsg)If InStr(retmsg,"no rows") = 0 Thenlogfile.WriteLine(Now() &amp; "---&gt;开始导出["&amp; code &amp;"]配置文件")rets = Split(retmsg,"--------------------------------------------------------------------------------")tttt = Split(rets(4),"Disconnected")result = tttt(0)ret = Split(result,Chr(10))val1 = Replace(Trim(ret(1)),Chr(13),"")val2 = Replace(Trim(ret(3)),Chr(13),"")val3 = Replace(Trim(ret(2)),Chr(13),"")val4 = Replace(Trim(ret(4)),Chr(13),"")val1 = Replace(val1,Chr(10),"")val2 = Replace(val2,Chr(10),"")val3 = Replace(val3,Chr(10),"")val4 = Replace(val4,Chr(10),"")url = mainurl &amp; "export/exportBatch"http.Open "POST",url,Falsehttp.setRequestHeader "Content-Type","application/x-www-form-urlencoded; charset=UTF-8"http.setRequestHeader "Accept-Encoding","gzip,deflate,sdch"http.setRequestHeader "Cache-Control","max-age=0"http.setRequestHeader "Connection","keep-alive"http.setRequestHeader "Cookie",cookieshttp.Send "list[0].consumerServiceInvokeId=" &amp; val1 &amp; "&amp;list[0].providerServiceInvokeId=" &amp; val2 &amp; "&amp;list[0].conGeneratorId=" &amp; val3 &amp; "&amp;list[0].proGeneratorId=" &amp; val4Set file1 = CreateObject("ADODB.Stream")file1.Mode = 3file1.Type = 1file1.Open()file1.write(http.responseBody)file1.SaveToFile metadatapath &amp; code &amp; "-" &amp; "metadata.zip",2logfile.WriteLine(Now() &amp; "---&gt;导出["&amp; code &amp;"]配置文件完成")Set file1 = NothingElseMsgBox "数据库未查询到配置信息,注意查看!!!"Exit SubEnd If '-------------解压文件---------------cmdstr = "cmd /c cd %cd%\" &amp; metadatapath  &amp; " &amp; winrar.exe x -ad -y "&amp; code &amp;"-metadata.zip"Set exeRs = wshshell.exec(cmdstr)'添加这句才能够等待执行完成结果，才能串行retmsg = exeRs.StdOut.ReadAll()'-------------比较元数据--------------'compareMeteData(code)'-------------拷贝文件至ESB路径下-----------'copyConfToSvn(code)End Sub'======================='查询对应系统的简称'=======================Function queryName(from)result = ""If attrDict.Exists(from) Thenresult = attrDict.Item(from)logfile.WriteLine(Now() &amp; "---&gt; 字典中已缓存，直接取缓存")Elselogfile.WriteLine(Now() &amp; "---&gt; 字典中未缓存，需要查库")cmdstr = "sqlplus "&amp; serviceurl &amp;" @" &amp; scriptpath &amp; "GetName.sql" &amp; " " &amp; fromSet exeRs = wshshell.exec(cmdstr)retmsg = exeRs.StdOut.ReadAll()If InStr(retmsg,"no rows") = 0 Thenrets = Split(retmsg,"--------------------------------------------------------------------------------")tttt = Split(rets(1),"Disconnected")result = Replace(tttt(0),Chr(10),"")result = Replace(result,Chr(13),"")ElseMsgBox "未查询到[" &amp; from &amp; "]对应的简称,注意查看!!!"End IfattrDict.Add from,resultEnd IfqueryName = resultEnd Function'======================='查询对应系统的名称'=======================Function queryCHName(from)result = ""If attrDict.Exists(from) Thenresult = attrDict.Item(from)logfile.WriteLine(Now() &amp; "---&gt;字典中已缓存，直接取缓存")Elselogfile.WriteLine(Now() &amp; "---&gt; 字典中未缓存，需要查库")cmdstr = "sqlplus "&amp; serviceurl &amp;" @" &amp; scriptpath &amp; "GetCHName.sql" &amp; " " &amp; fromlogfile.WriteLine(Now() &amp; "---&gt; " &amp; cmdstr)Set exeRs = wshshell.exec(cmdstr)retmsg = exeRs.StdOut.ReadAll()If InStr(retmsg,"no rows") = 0 Thenrets = Split(retmsg,"--------------------------------------------------------------------------------")tttt = Split(rets(1),"Disconnected")result = Replace(tttt(0),Chr(10),"")result = Replace(result,Chr(13),"")ElseMsgBox "未查询到[" &amp; from &amp; "]对应的简称,注意查看!!!"End IfattrDict.Add from,resultEnd IfqueryCHName = resultEnd Function'======================='修改服务识别和系统识别'=======================Sub modifyXml(from,dest,code)logfile.WriteLine(Now() &amp; "---&gt;开始修改公共文件")pathService = commpath &amp; "serviceIdentify.xml"pathSystem = commpath &amp; "systemIdentify.xml"'连接数据库查询相关数据logfile.WriteLine(Now() &amp; "---&gt;开始查询[" &amp; from &amp; "]对应的简称")serviceId = Left(code,11)senceId = Right(code,2)result = queryName(from)If result = "" Thenlogfile.WriteLine(Now() &amp; "---&gt;没查到简称呢，直接退出了哟.....")Exit SubEnd If logfile.WriteLine(Now() &amp; "---&gt;[" &amp; from &amp; "]===&gt;[" &amp; result &amp; "]")logfile.WriteLine(Now() &amp; "---&gt;查询[" &amp; from &amp; "]对应的简称结束")logfile.WriteLine(Now() &amp; "---&gt;开始修改[" &amp; pathService &amp; "]文件")xdoc.Load(pathService)ReadServiceXml xdoc,result,from,dest,codexdoc.Save pathServicelogfile.WriteLine(Now() &amp; "---&gt;修改[" &amp; pathService &amp; "]文件结束")logfile.WriteLine(Now() &amp; "---&gt;开始修改[" &amp; pathSystem &amp; "]文件")xdoc.Load(pathSystem)ReadSystemXml  xdoc,result,dest,codexdoc.Save pathSystemlogfile.WriteLine(Now() &amp; "---&gt;修改[" &amp; pathSystem &amp; "]文件结束")logfile.WriteLine(Now() &amp; "---&gt;修改公共文件结束")End Sub'======================='解析服务识别文件并添加新交易'=======================Sub ReadServiceXml(xdoc,from,ch_name,dest,code)'取出所有channelSet nodes = xdoc.documentElement.selectNodes(".//channel")For Each node In nodesSet Alist = node.AttributesDim node2For i = 0 To Alist.Length - 1Dim attrSet attr = Alist.Item(i)If attr.NodeName = "id" And attr.NodeValue = from Then'取出所有 switchSet m = node.getElementsByTagName("switch")(0)Set childs = m.childNodesFor Each node1 In node.selectNodes(".//switch")For j = 0 To node1.ChildNodes.Length -1Set tmp = node1.ChildNodes(j)Set node2 = node1'判断是否存在该交易If tmp.NodeType = 1 And tmp.NodeName = "case" And Trim(tmp.Text) = code Then'有的话直接退出logfile.WriteLine(Now() &amp; "---&gt;存在该调用关系"&amp; from &amp;" -- " &amp; code)Exit SubEnd If NextNext'在注释处插入该交易For n = 1 To childs.length-1If childs(n).NodeType = 8 ThenIf Trim(childs(n).NodeValue) = dest ThenSet nodetmp = xdoc.createElement("case")Set nodeattr = xdoc.createAttribute("value")If from = "ECIF" Or from = "PPL" Or from = "BIBPS" Thennodeattr.text = codenodetmp.setAttributeNode nodeattrnodetmp.text = codeElsenodeattr.text = "Req" &amp; codenodetmp.setAttributeNode nodeattrnodetmp.text = codeEnd Ifm.insertBefore nodetmp,childs(n+1)logfile.WriteLine(Now() &amp; "---&gt; 在注释处插入该交易 "&amp; from &amp;" --&gt; " &amp; code &amp; " --&gt; " &amp; dest)Exit SubEnd If End IfNext'插入注释和交易Set nodetmp = xdoc.createElement("case")Set nodeattr = xdoc.createAttribute("value")Set nodecomm = xdoc.createComment(dest)If from = "ECIF" Or from = "PPL" Or from = "BIBPS"Thennodeattr.text = codenodetmp.setAttributeNode nodeattrnodetmp.text = codeElsenodeattr.text = "Req" &amp; codenodetmp.setAttributeNode nodeattrnodetmp.text = codeEnd Ifm.appendChild(nodecomm)m.appendChild(nodetmp)Exit SubEnd If NextNext'若没有查到CHANNEL则为新增渠道，需要新增渠道logfile.WriteLine(Now() &amp; "---&gt;**********此渠道为新增渠道 "&amp; from &amp;" --&gt; " &amp; code &amp; " --&gt; " &amp; dest)Set channels = xdoc.documentElementlogfile.WriteLine(Now() &amp; "---&gt; 新增 CHANNEL 节点")Set channel = xdoc.createElement("channel")Set channelid = xdoc.createAttribute("id")Set channeltype = xdoc.createAttribute("type")channelid.text = fromchannel.setAttributeNode channelidchanneltype.text = "dynamic"channel.setAttributeNode channeltypelogfile.WriteLine(Now() &amp; "---&gt; 新增 Switch 节点")Set switch = xdoc.createElement("switch")Set switchmode = xdoc.createAttribute("mode")Set switchexpression = xdoc.createAttribute("expression")switchmode.text = "soap"switch.setAttributeNode switchmodeswitchexpression.text = "/soapenv:Envelope/soapenv:Body"switch.setAttributeNode switchexpressionlogfile.WriteLine(Now() &amp; "---&gt; 新增 namespace 节点")Set namespace = xdoc.createElement("namespace")Set namespacevalue = xdoc.createAttribute("value")namespacevalue.text = "soapenv"namespace.setAttributeNode namespacevaluenamespace.text = "http://schemas.xmlsoap.org/soap/envelope/"logfile.WriteLine(Now() &amp; "---&gt; 新增 交易 节点")Set nodetmp = xdoc.createElement("case")Set nodeattr = xdoc.createAttribute("value")Set nodecomm = xdoc.createComment(dest)If from = "ECIF" Or from = "PPL" Or from = "BIBPS" Thennodeattr.text = codenodetmp.setAttributeNode nodeattrnodetmp.text = codeElsenodeattr.text = "Req" &amp; codenodetmp.setAttributeNode nodeattrnodetmp.text = codeEnd Ifchannels.appendChild(channel)channel.appendChild(switch)switch.appendChild(namespace)switch.appendChild(nodecomm)switch.appendChild(nodetmp)'执行 渠道插入脚本 RunSqlScript from,"","AddChannel"End Sub'======================='将执行结果写回到文件'=======================Sub AddLineAfterWord(frompath,topath,word,text)'非标准的XML文件，不能使用XML函数处理logfile.WriteLine(Now() &amp; "---&gt;开始添加元数据的差异")If Trim(text) = "" Thenlogfile.WriteLine(Now() &amp; "---&gt;无差异，无需操作")Exit Sub End If Set fso = CreateObject("Scripting.FileSystemObject")pathMetadata4Read = frompathpathMetadata4Write = topathSet fileMetadata4Read = fso.OpenTextFile(pathMetadata4Read,1,False)Set fileMetadata4Write = fso.OpenTextFile(pathMetadata4Write,2,True)Do While fileMetadata4Read.AtEndOfStream &lt;&gt; Trueline = fileMetadata4Read.ReadLine()If Trim(line) = "&lt;/"&amp; word &amp;"&gt;" Then fileMetadata4Write.Write(text)fileMetadata4Write.WriteLine("&lt;/"&amp; word &amp;"&gt;")ElsefileMetadata4Write.WriteLine lineEnd IfLoopfileMetadata4Read.close()fileMetadata4Write.close()Set fso = Nothinglogfile.WriteLine(Now() &amp; "---&gt;内容如下")logfile.WriteLine(Now() &amp; "---&gt;")logfile.WriteLine(text)logfile.WriteLine(Now() &amp; "---&gt;完成添加元数据的差异")End Sub'======================='未使用'=======================Sub notuse()Set xdocu = CreateObject("MSXML2.DOMDocument")pathMetadata = commpath &amp; "metadata.xml"xdocu.Load(pathMetadata)Set nodetmp1 = xdocu.documentElementMsgBox (nodetmp1 Is Nothing)Set cNode = xdocu.createElement(nodename)Set nodeattr1 = xdocu.createAttribute("type")nodeattr1.text = nodetypecNode.setAttributeNode nodeattr1If nodetype = "string" Then Set nodeattr2 = xdocu.createAttribute("length")nodeattr2.text = "255"cNode.setAttributeNode nodeattr2End If nodetmp1.appendChild(cNode)xdocu.Save pathMetadataEnd Sub '======================='解析系统识别并添加新增交易'=======================Sub ReadSystemXml(xdoc,from,dest,code)logfile.WriteLine(Now() &amp; from &amp;" --&gt; " &amp; code &amp; " --&gt; " &amp; dest)Set nodes = xdoc.documentElement.selectNodes(".//system")For Each node In nodesSet Alist = node.AttributesFor i = 0 To Alist.Length - 1Dim attrSet attr = Alist.Item(i)If attr.NodeName = "id" And attr.NodeValue = dest ThenFor Each node1 In node.selectNodes(".//service")If node1.Text = code Thenlogfile.WriteLine(Now() &amp; "存在该交易.......")Exit Sub End IfNext'插入该交易Set cNode = xdoc.createElement("service")cNode.Text = codenode.appendChild(cNode)Exit SubEnd IfNextNext'若是新增系统问题logfile.WriteLine(Now() &amp; "---&gt;**********系统[ " &amp; dest &amp; " ]为新增提供方 "&amp; from &amp;" --&gt; " &amp; code &amp; " --&gt; " &amp; dest)Set systems = xdoc.documentElementSet system = xdoc.createElement("system")Set systemid = xdoc.createAttribute("id")systemid.text = destsystem.setAttributeNode systemidSet cNode = xdoc.createElement("service")cNode.Text = codesystems.appendChild(system)system.appendChild(cNode)ch_name=queryCHName(dest)'MsgBox (dest &amp; "--&gt;" &amp; ch_name)'执行 系统插入脚本 RunSqlScript dest,ch_name,"AddSystem"End Sub'======================='加载元数据'=======================Sub loadMetaData()logfile.WriteLine(Now() &amp; "---&gt;开始加载最新Metadata.xml文件...")Set fso = CreateObject("Scripting.FileSystemObject")Set svnfile = fso.OpenTextFile(svnmetadata,1,False)Do While svnfile.AtEndOfStream &lt;&gt; Trueline = svnfile.ReadLine()If InStr(line,"type") &gt; 0 Then tmpp = Split(line,"&lt;")(1)name = Trim(Split(tmpp," ")(0))alldata = alldata &amp; name &amp; ","End IfLooplogfile.WriteLine(Now() &amp; "---&gt;加载最新Metadata.xml完成..." )Set fso = NothingEnd Sub '======================='比对元数据'=======================Sub compareMeteData(code)'文件方式比较logfile.WriteLine(Now() &amp; "---&gt;开始比较[" &amp; code &amp; "]与元数据的差异")Set fso = CreateObject("Scripting.FileSystemObject")temp = newpath &amp; code &amp; "-metadata\in_config\servicedefine"Set localfile = fso.GetFolder(temp)Set outpath = fso.CreateTextFile(newpath &amp; "\out" &amp; code &amp; ".txt",True)Set oFiles = localfile.FilesFor Each oFile In oFilestmppath = oFile.PathSet file1 = fso.OpenTextFile(tmppath,1,False)Do While file1.AtEndOfStream &lt;&gt; Trueline = file1.ReadLine()If InStr(line,"metadataid") &gt; 0 Thentmpp = Split(line,"metadataid")(1)tmpp1 = Trim(Split(tmpp,Chr(34))(1))If InStr(line,"type") &gt; 0 Thentmpp2 = Split(line,"type")(1)tmpp3 = Split(tmpp2,Chr(34))(1)isExists = 1checkExists alldata,tmpp1,isExists'MsgBox len(alldata)   416771If (tmpp3 = "array" Or tmpp3 = "sopform") And isExists = 0 Thenoutpath.WriteLine("&lt;" &amp; tmpp1 &amp; " type=" &amp; Chr(34) &amp; "array"&amp; Chr(34) &amp;"/&gt;")logfile.WriteLine(Now() &amp; "---&gt;开始添加[" &amp; tmpp1 &amp; "]元数据,类型为[array]")'添加已经添加的字段，以免重复新增allNewData = allNewData &amp; "&lt;" &amp; tmpp1 &amp; " type=" &amp; Chr(34) &amp; "array"&amp; Chr(34) &amp;"/&gt;"&amp; vbcrlfalldata = alldata &amp; tmpp1 &amp; ","End If ElseisExists = 1checkExists alldata,tmpp1,isExistsIf isExists = 0 Thenoutpath.WriteLine("&lt;" &amp; tmpp1 &amp; " type=" &amp; Chr(34) &amp; "string"&amp; Chr(34) &amp;" length="&amp; Chr(34) &amp; "255" &amp; Chr(34) &amp;"/&gt;")logfile.WriteLine(Now() &amp; "---&gt;开始添加[" &amp; tmpp1 &amp; "]元数据,类型为[string]")allNewData = allNewData &amp; "&lt;" &amp; tmpp1 &amp; " type=" &amp; Chr(34) &amp; "string"&amp; Chr(34) &amp;" length="&amp; Chr(34) &amp; "255" &amp; Chr(34) &amp;"/&gt;" &amp; vbcrlfalldata = alldata &amp; tmpp1 &amp; ","End IfEnd IfEnd IfLoopNextSet fso = Nothinglogfile.WriteLine(Now() &amp; "---&gt;完成比较[" &amp; code &amp; "]与元数据的差异")End Sub'======================='修改拆组包文件'=======================Sub modifyPackFile(from,dest,code)'此处需要根据各个现场修改'修改拆组包文件逻辑需要再次判断'isExistFlag = FalseSet fso = CreateObject("Scripting.FileSystemObject")logfile.WriteLine(Now() &amp; "---&gt;开始修改拆组包文件[" &amp; code &amp; "]")If Not fso.fileExists("Template\" &amp; dest &amp; ".xml") Or isExistFlag Thenlogfile.WriteLine(Now() &amp; "---&gt;没有模版文件[" &amp; code &amp; "]")Exit Sub End If servicepath = newpath &amp; code &amp; "-metadata\out_config\" &amp; dest &amp; "\service_"&amp; code &amp;"_system_" &amp; dest &amp; ".xml"servicenewpath = newpath &amp; "service\service_"&amp; code &amp;"_system_" &amp; dest &amp; ".xml"channelepath = newpath &amp; code &amp; "-metadata\out_config\" &amp; dest &amp; "\channel_" &amp; dest &amp; "_service_" &amp; code &amp; ".xml"channelenewpath = newpath &amp; "service\channel_" &amp; dest &amp; "_service_" &amp; code &amp; ".xml"logfile.WriteLine(Now() &amp; "---&gt;开始修改组包文件[" &amp; code &amp; "]")xdoc.load(servicepath)tmp1 = Replace(xdoc.xml,"s:","")tmp2 = Replace(tmp1,"d:","")tmp = Replace(tmp2,":","")tp = Replace(tmp,"xmlns=" &amp; Chr(34) &amp; "http//esb.dcitsbiz.com/services/"&amp; Left(code,11) &amp; Chr(34),"")xdoc.loadXML(tp)Set nodes = xdoc.documentElement.selectNodes(".//ReqAppBody")(0)addstr = ""For Each node In nodes.ChildNodesaddstr = addstr  &amp; "" &amp; node.Xml &amp; vbcrlfNextRepalceFile "Template\" &amp; dest &amp; ".xml",servicenewpath,addstrlogfile.WriteLine(Now() &amp; "---&gt;开始修改拆包文件[" &amp; code &amp; "]")xdoc.load(channelepath)tmp1 = Replace(xdoc.xml,"s:","")tmp2 = Replace(tmp1,"d:","")tmp = Replace(tmp2,":","")tp = Replace(tmp,"xmlns=" &amp; Chr(34) &amp; "http//esb.dcitsbiz.com/services/"&amp; Left(code,11) &amp; Chr(34),"")xdoc.loadXML(tp)Set nodes = xdoc.documentElement.selectNodes(".//RspAppBody")(0)addstr = ""For Each node In nodes.ChildNodesaddstr = addstr  &amp; "" &amp; node.Xml &amp; vbcrlfNextRepalceFile "Template\" &amp; dest &amp; ".xml",channelenewpath,addstrlogfile.WriteLine(Now() &amp; "---&gt;完成修改拆组包文件[" &amp; code &amp; "]")End Sub'======================='替换文件'=======================Sub RepalceFile(fromfile,tofile,text)Set file1 = CreateObject("ADODB.Stream")file1.Mode = 3file1.Type = 1file1.Open()file1.LoadFromFile fromfilefile1.Position = 0file1.Type = 2file1.Charset = "utf-8"tmpfile = file1.ReadTextfile1.Position = 0file1.SetEosfile1.Type = 2file1.Charset = "utf-8"file1.WriteText Replace(tmpfile,"XXXXXXXXXXXXXXXXXXXX",text)file1.SaveToFile tofile,2Set file1 = NothingEnd Sub'======================='检查元数据是否存在'=======================Function checkExists(strBase,strNeed,isExists)startPos = InStr(strBase,strNeed)If startPos = 0 ThenisExists = 0Exit FunctionElse'此处若需要的元数据在字段结尾会出现问题isExists = startPosEnd IfendPos = InStr(startPos,strBase,",")newstart = InstrRev(Mid(strBase,1,startPos),",")newval =  Mid(strBase,newstart+1,endPos-newstart-1)newStrBase = Mid(strBase,endPos)'只有长度相等的元数据才继续检查,减少递归的次数While Len(newval) &lt;&gt; Len(strNeed)startPos = InStr(newStrBase,strNeed)'若新的基础字符串中不含需要的元数据，直接退出If startPos = 0 ThenisExists = 0Exit FunctionEnd IfendPos = InStr(startPos,newStrBase,",")newstart = InstrRev(Mid(newStrBase,1,startPos),",")newval =  Mid(newStrBase,newstart+1,endPos-newstart-1)newStrBase = Mid(newStrBase,endPos)WendIf strNeed &lt;&gt; newval ThencheckExists newStrBase,strNeed,isExistsElseisExists = newstart+1Exit FunctionEnd If End Function'======================='拷贝元数据至SVN'=======================Sub copyConfToSvn(code,from)logfile.WriteLine(Now() &amp; "---&gt;开始拷贝文件至SVN[" &amp; code &amp; "]")intemp = newpath &amp; code &amp; "-metadata\in_config\"outtemp = newpath &amp; code &amp; "-metadata\out_config\"Set fso = CreateObject("Scripting.FileSystemObject")Set oFolder = fso.GetFolder(intemp)Set oSubFolder = oFolder.SubFoldersSet outFolder = fso.GetFolder(outtemp)Set outSubFolder = outFolder.SubFolders'isExistFlag = FalseFor Each otmp In oSubFolderIf isExistFlag ThenIf Trim(LCase(otmp.Name)) &lt;&gt; "servicedefine" Then logfile.WriteLine(Now() &amp; "---&gt;开始拷贝文件夹--&gt;[" &amp; intemp &amp; otmp.Name &amp; "]")fso.CopyFolder intemp &amp; otmp.Name &amp; "*",svndestinEnd If Elselogfile.WriteLine(Now() &amp; "---&gt;开始拷贝文件夹--&gt;[" &amp; intemp &amp; otmp.Name &amp; "]")fso.CopyFolder intemp &amp; otmp.Name &amp; "*",svndestinEnd If Next For Each itmp In outSubFolderIf Not isExistFlag Thenlogfile.WriteLine(Now() &amp; "---&gt;开始拷贝文件夹--&gt;[" &amp; outtemp &amp; "]")fso.CopyFolder outtemp &amp; "*",svndestoutEnd If NextSet fso = NothingEnd Sub'======================='加载文件中的交易'=======================Function LoadTrans()versionLog()Set fso = CreateObject("Scripting.FileSystemObject")Set traninfo = fso.OpenTextFile("traninfo.txt",1,False)tmpstr = ""Do While traninfo.AtEndOfStream &lt;&gt; Trueline = traninfo.ReadLine()If Trim(line) &lt;&gt; "" Thennum = Len(line)- Len(Replace(line," ",""))If num &lt;&gt; 2 ThenExit FunctionEnd If tmpstr = tmpstr &amp; Replace(line," ",",") &amp; ";"End IfLoop'拷贝文件至tmp下serviceIdentify = "serviceIdentify.xml"systemIdentify = "systemIdentify.xml"metadata = "metadata.xml"fso.copyfile inconfpath &amp; serviceIdentify,commpath &amp; serviceIdentifyfso.copyfile inconfpath &amp; systemIdentify,commpath &amp; systemIdentifyfso.copyfile svnmetadata,commpath &amp; metadataLoadTrans = tmpstrSet fso = NothingEnd Function'=======================' 更新SVN'=======================Function updateSVN()logfile.WriteLine(Now() &amp; "---&gt;开始更新 SVN .......")cmdstr = "svn update "&amp; svnpathSet exeRs = wshshell.exec(cmdstr)retmsg = exeRs.StdOut.ReadAll()logfile.WriteLine(Now() &amp; "---&gt;更新 SVN 日志如下:")logfile.WriteLine( retmsg)logfile.WriteLine(Now() &amp; "---&gt;更新 SVN 完成.......")End Function'======================='主方法'=======================Sub Main()'tranText = InputBox("请输入需要开发的交易，形如[3001300000333,双屏系统,NCBS;]","提醒","3001300000333,双屏系统,NCBS;")'==========更新SVN至最新============updateSVN'==========加载文本文件中的交易============tranText = LoadTrans()If tranText = "" ThenMsgBox "请检查[ traninfo.txt ]是否已[ 经粘贴交易 ] 或 [ 有多余空格 ]!",0,"星阳提醒"Exit SubElseAns = MsgBox("[开始处理]:   共[ " &amp;  UBound(Split(tranText,";")) &amp; " ]个交易" &amp; Chr(13) &amp; tranText,VbOKCancel,"星阳提醒")If Ans = vbCancel ThenMsgBox "你取消了操作！",0,"星阳提醒"Exit Sub End If'==========登录服务治理平台============login "admin","753951"'===========加载最新元数据=============loadMetaData()'分割每条记录trans = Split(tranText,";")'根据填写的执行方法进行tranFlow = InputBox("请输入需要执行的动作:" &amp; Chr(13) &amp; "    1.  检查交易是否为新增       [ 1 ]" &amp; Chr(13) &amp; "    2.  导出并只执行脚本         [ 2 ]" &amp; Chr(13) &amp; "    3.  导出相关配置文件         [ 3 ]" &amp; Chr(13) &amp; "    4.  修改公共文件结构         [ 4 ]" &amp; Chr(13) &amp; "    5.  比较元数据差异           [ 5 ]" &amp; Chr(13) &amp; "    6.  拷贝文件至SVN路径        [ 6 ]" &amp; Chr(13) &amp; "    7.  修改组包文件             [ 7 ]" &amp; Chr(13) &amp; "    8.  修改Metadata.xml文件     [ 8 ]" &amp; Chr(13) &amp; "    9.  运行文件比对             [ 9 ]" &amp; Chr(13) &amp; "    10. 流程全部执行             [ A ]","提醒","A")tranFlow = UCase(tranFlow)If tranFlow = "" Then MsgBox "你取消了操作！"Exit SubEnd IfFor i= 0 To UBound(trans)'分割交易明细信息  --&gt;  3001300000333,双屏系统,NCBS;If trans(i) &lt;&gt; "" Thentraninfo =  Split(trans(i),",")code = Trim(traninfo(0))from = Trim(traninfo(1))dest = Trim(traninfo(2))'=========检查交易是否为新增===========If InStr(tranFlow,"1") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThencheckTran code,from,destEnd If '==========导出并只执行脚本============If InStr(tranFlow,"2") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThenexportAndRunSQLOne(code)End If '==========导出相关配置文件============If InStr(tranFlow,"3") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThenexportConf from,dest,codeEnd If'==========修改公共文件结构============If InStr(tranFlow,"4") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThenmodifyXml from,dest,codeEnd If '===========比较元数据差异=============If InStr(tranFlow,"5") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThencompareMeteData codeEnd If '========拷贝文件至SVN路径=============If InStr(tranFlow,"6") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThencopyConfToSvn code,fromEnd If '===========修改组包文件===============If InStr(tranFlow,"7") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThenmodifyPackFile from,dest,codeEnd If End If Next'修改Metadata.xml文件If InStr(tranFlow,"8") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 ThenAddLineAfterWord svnmetadata,commpath &amp; "metadata.xml","metadata",allNewDataEnd If '运行文件比对'CompareAns = MsgBox("需要进行文件比对吗？",VbOKCancel,"星阳提醒")'If CompareAns &lt;&gt; vbCancel ThenIf InStr(tranFlow,"9") &gt; 0 Or InStr(tranFlow,"A") &gt; 0 Then'比对 serviceIdentify.xmlwshshell.run("BComp.exe " &amp; commpath &amp; "serviceIdentify.xml "&amp; inconfpath &amp;"serviceIdentify.xml")'比对 systemIdentify.xmlwshshell.run("BComp.exe " &amp; commpath &amp; "systemIdentify.xml "&amp; inconfpath &amp;"systemIdentify.xml")'比对 metadata.xmlwshshell.run("BComp.exe " &amp; commpath &amp; "metadata.xml "&amp; inconfpath &amp;"metadata\metadata.xml")'in out 比对wshshell.run("BComp.exe " &amp; outconfpath &amp; "systemIdentify.xml "&amp; inconfpath &amp;"systemIdentify.xml")wshshell.run("BComp.exe " &amp; outconfpath &amp; "metadata\metadata.xml "&amp; inconfpath &amp;"metadata\metadata.xml")'End IfEnd IfEnd Iflogfile.WriteLine(Now() &amp; "---&gt;配置文件共[" &amp; totalNum &amp; "]个")MsgBox "o(∩_∩)o 啦啦啦-&gt;[ 全部处理完成 ] o(∩_∩)o",0,"星阳提醒"End SubMain()Set http = NothingSet html = NothingSet wshshell = NothingSet xdoc = NothingSet logfso = NothingSet tranfso = Nothing<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a>5.总结</h3><hr><p>代码不复杂，就是要把各个东西串联起来比较麻烦。在这做个备份，以防以后会用到中间的东西。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> vbs </tag>
            
            <tag> 效率 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HA江苏电费插件</title>
      <link href="2021/04/06/jsdf/"/>
      <url>2021/04/06/jsdf/</url>
      
        <content type="html"><![CDATA[<h3 id="0-前言介绍"><a href="#0-前言介绍" class="headerlink" title="0.前言介绍"></a>0.前言介绍</h3><hr><p>之前一直想把水电燃气都接入HA，水和燃气都接入了，电费一直没有接入。一开始尝试网上抓包，有个变量没摸透它的规律，所以没办法入手。后面发现小程序也可以查电费，所以准备从小程序入手，抓包看看能不能够有什么发现。</p><h3 id="1-抓包准备"><a href="#1-抓包准备" class="headerlink" title="1.抓包准备"></a>1.抓包准备</h3><hr><p>搜索微信小程序 <strong>国网江苏电力营业厅</strong> 抓下包。抓包的工具可以使用 <strong>Fiddler</strong>  苹果手机上可以使用 <strong>Stream</strong> 都是挺好用的。</p><h3 id="2-抓包"><a href="#2-抓包" class="headerlink" title="2.抓包"></a>2.抓包</h3><hr><p>在抓包的结果中找找有没有哪个返回金额等相关数据的。找了找，找到了 <strong><a href="https://weixin.js.sgcc.com.cn/wxapp_dlsh/wx/oauth_executeNewMini.do?openid=xxxxxxxxx&amp;timestamp=xxxxx&amp;noncestr=xxxxxxx&amp;sign=xxxxxxxx&amp;unionid=xxxxxxx&amp;userInfo=null">https://weixin.js.sgcc.com.cn/wxapp_dlsh/wx/oauth_executeNewMini.do?openid=xxxxxxxxx&amp;timestamp=xxxxx&amp;noncestr=xxxxxxx&amp;sign=xxxxxxxx&amp;unionid=xxxxxxx&amp;userInfo=null</a></strong> 这个地址。通过多次对比这个链接，发现  </p><p><strong>openid=xxxxxxxxx   //固定的</strong><br><strong>timestamp=xxxxx</strong>   <strong>// 变动的</strong></p><p><strong>noncestr=xxxxxxx</strong>  <strong>//变动的</strong><br><strong>sign=xxxxxxxx      // 变动的</strong><br><strong>unionid=xxxxxxx</strong>    <strong>//固定的</strong></p><p><strong>timestamp</strong> <strong>noncestr</strong> <strong>sign</strong> 这三个参数是有关联关系，不能够随意改动。这个地址的返回结果中也会返回这三个字段，所以我们不必考虑他们之间的关系，再次调用是，把之前的参数替换成现在最新的即可。</p><h3 id="3-编写插件"><a href="#3-编写插件" class="headerlink" title="3.编写插件"></a>3.编写插件</h3><hr><p>分析到上面那步之后插件写起来就简单了，其实就是解析参数赋值的事情了。代码如下:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""Support for guojiadianwang# Author:    freefitter# Created:    2020/9/2"""</span><span class="token keyword">import</span> logging<span class="token keyword">import</span> json<span class="token keyword">import</span> configparser<span class="token keyword">import</span> time<span class="token punctuation">,</span> datetime<span class="token keyword">from</span> dateutil<span class="token punctuation">.</span>relativedelta <span class="token keyword">import</span> relativedelta <span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>const <span class="token keyword">import</span> <span class="token punctuation">(</span>    CONF_API_KEY<span class="token punctuation">,</span> CONF_NAME<span class="token punctuation">,</span> ATTR_ATTRIBUTION<span class="token punctuation">,</span> CONF_ID    <span class="token punctuation">)</span><span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span>entity <span class="token keyword">import</span> Entity<span class="token keyword">import</span> homeassistant<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span>config_validation <span class="token keyword">as</span> cv<span class="token keyword">import</span> voluptuous <span class="token keyword">as</span> vol<span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>components<span class="token punctuation">.</span>sensor <span class="token keyword">import</span> PLATFORM_SCHEMA<span class="token keyword">import</span> requests<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup_Log<span class="token operator">=</span>logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>DEFAULT_NAME <span class="token operator">=</span> <span class="token string">'gjdw'</span>OPENID <span class="token operator">=</span> <span class="token string">'openid'</span>NONCESTR <span class="token operator">=</span> <span class="token string">'noncestr'</span>SIGN <span class="token operator">=</span> <span class="token string">'sign'</span>UNIONID <span class="token operator">=</span> <span class="token string">'unionid'</span>TIMESTAMP1 <span class="token operator">=</span> <span class="token string">'timestamp'</span>PLATFORM_SCHEMA <span class="token operator">=</span> PLATFORM_SCHEMA<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">{</span>vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>OPENID<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>NONCESTR<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>SIGN<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>UNIONID<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>TIMESTAMP1<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>    vol<span class="token punctuation">.</span>Optional<span class="token punctuation">(</span>CONF_NAME<span class="token punctuation">,</span> default<span class="token operator">=</span> DEFAULT_NAME<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>HEADERS <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">'Host'</span><span class="token punctuation">:</span> <span class="token string">'weixin.js.sgcc.com.cn'</span><span class="token punctuation">,</span>    <span class="token string">'Connection'</span><span class="token punctuation">:</span>  <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>    <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>    <span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>    <span class="token string">'Accept-Encoding'</span><span class="token punctuation">:</span> <span class="token string">'gzip,compress,br,deflate'</span><span class="token punctuation">,</span>    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (iPhone; CPU iPhone OS 14_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.0(0x18000026) NetType/WIFI Language/zh_CN'</span><span class="token punctuation">,</span>    <span class="token string">'Referer'</span><span class="token punctuation">:</span> <span class="token string">'https://servicewechat.com/wx203b37ad2ad5d2a6/32/page-frame.html'</span><span class="token punctuation">,</span><span class="token punctuation">}</span>API_URL <span class="token operator">=</span> <span class="token string">"https://weixin.js.sgcc.com.cn/wxapp_dlsh/wx/oauth_executeNewMini.do"</span><span class="token keyword">def</span> <span class="token function">setup_platform</span><span class="token punctuation">(</span>hass<span class="token punctuation">,</span> config<span class="token punctuation">,</span> add_devices<span class="token punctuation">,</span> discovery_info<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sensor_name <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>CONF_NAME<span class="token punctuation">)</span>    openid <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>OPENID<span class="token punctuation">)</span>    unionid <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>UNIONID<span class="token punctuation">)</span>    cfg <span class="token operator">=</span> configparser<span class="token punctuation">.</span>ConfigParser<span class="token punctuation">(</span><span class="token punctuation">)</span>    cfg<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'param.ini'</span><span class="token punctuation">)</span>    timestamp1 <span class="token operator">=</span> cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Param'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">)</span>    noncestr <span class="token operator">=</span> cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Param'</span><span class="token punctuation">,</span> <span class="token string">'noncestr'</span><span class="token punctuation">)</span>    sign <span class="token operator">=</span> cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Param'</span><span class="token punctuation">,</span> <span class="token string">'sign'</span><span class="token punctuation">)</span>        url <span class="token operator">=</span> API_URL <span class="token operator">+</span> <span class="token string">"?openid="</span> <span class="token operator">+</span> openid <span class="token operator">+</span><span class="token string">"&amp;timestamp="</span> <span class="token operator">+</span> timestamp1 <span class="token operator">+</span> <span class="token string">"&amp;noncestr="</span> <span class="token operator">+</span> noncestr <span class="token operator">+</span> <span class="token string">"&amp;sign="</span> <span class="token operator">+</span> sign <span class="token operator">+</span> <span class="token string">"&amp;unionid="</span> <span class="token operator">+</span> unionid <span class="token operator">+</span> <span class="token string">"&amp;userInfo=null"</span>        _Log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"url:"</span> <span class="token operator">+</span> url <span class="token punctuation">)</span>    add_devices<span class="token punctuation">(</span><span class="token punctuation">[</span>GJDW<span class="token punctuation">(</span>sensor_name<span class="token punctuation">,</span>url<span class="token punctuation">,</span>openid<span class="token punctuation">,</span>unionid<span class="token punctuation">,</span>cfg<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">GJDW</span><span class="token punctuation">(</span>Entity<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Representation of a guojiadianwang """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>sensor_name<span class="token punctuation">,</span>url<span class="token punctuation">,</span>openid<span class="token punctuation">,</span>unionid<span class="token punctuation">,</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>attributes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        self<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token boolean">None</span>        self<span class="token punctuation">.</span>_name <span class="token operator">=</span> sensor_name        self<span class="token punctuation">.</span>_url <span class="token operator">=</span> url        self<span class="token punctuation">.</span>_openid <span class="token operator">=</span> openid        self<span class="token punctuation">.</span>_unionid <span class="token operator">=</span> unionid        self<span class="token punctuation">.</span>_cfg <span class="token operator">=</span> cfg    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the name of the sensor."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_name    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the state of the sensor."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_state    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">icon</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""   mdi   ."""</span>        <span class="token keyword">return</span> <span class="token string">'mdi:flash'</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">device_state_attributes</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the state attributes."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>attributes    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">unit_of_measurement</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the unit this state is expressed in."""</span>        <span class="token keyword">return</span> <span class="token string">"元"</span>    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token triple-quoted-string string">"""_Log.error("url:" + self._url)"""</span>            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_url<span class="token punctuation">,</span>headers <span class="token operator">=</span> HEADERS<span class="token punctuation">)</span>        <span class="token keyword">except</span> ReadTimeout<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Connection timeout...."</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> ConnectionError<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Connection Error...."</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> RequestException<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Unknown Error"</span><span class="token punctuation">)</span>        res <span class="token operator">=</span> response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> res<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"html"</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"参数存在问题,请重新抓包填写"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span>            <span class="token triple-quoted-string string">"""_Log.error(res)"""</span>        ret <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>res<span class="token punctuation">)</span>        <span class="token keyword">if</span> ret<span class="token punctuation">[</span><span class="token string">"errcode"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"0000"</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token string">"owe_amt"</span> <span class="token keyword">in</span> ret<span class="token punctuation">[</span><span class="token string">"yeModel"</span><span class="token punctuation">]</span> <span class="token punctuation">:</span>                self<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token string">"yeModel"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"owe_amt"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'rca_flag'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"yeModel"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"rca_flag"</span><span class="token punctuation">]</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'cur_amt'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token string">"yeModel"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cur_amt"</span><span class="token punctuation">]</span>                curfeeMsg <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token string">"curfee"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'ymd'</span><span class="token punctuation">]</span> <span class="token operator">=</span> curfeeMsg<span class="token punctuation">[</span><span class="token string">"ymd"</span><span class="token punctuation">]</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'totalMoney'</span><span class="token punctuation">]</span> <span class="token operator">=</span> curfeeMsg<span class="token punctuation">[</span><span class="token string">"totalMoney"</span><span class="token punctuation">]</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'powerSum'</span><span class="token punctuation">]</span> <span class="token operator">=</span> curfeeMsg<span class="token punctuation">[</span><span class="token string">"powerSum"</span><span class="token punctuation">]</span>                dbObjMsg <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token string">"dbObj"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'stepNo'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dbObjMsg<span class="token punctuation">[</span><span class="token string">"stepNo"</span><span class="token punctuation">]</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'yearAmount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dbObjMsg<span class="token punctuation">[</span><span class="token string">"yearAmount"</span><span class="token punctuation">]</span>                self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'isUpdated'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'yes'</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'rca_flag'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'-1'</span>            self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'cur_amt'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'-1'</span>            self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'isUpdated'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'no'</span>            <span class="token comment">#_Log.error("yeModel is null !")</span>            <span class="token comment"># 更新url参数 </span>            url <span class="token operator">=</span> API_URL <span class="token operator">+</span> <span class="token string">"?openid="</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>_openid <span class="token operator">+</span><span class="token string">"&amp;timestamp="</span> <span class="token operator">+</span> ret<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&amp;noncestr="</span> <span class="token operator">+</span> ret<span class="token punctuation">[</span><span class="token string">"noncestr"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&amp;sign="</span> <span class="token operator">+</span> ret<span class="token punctuation">[</span><span class="token string">"sign"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&amp;unionid="</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>_unionid <span class="token operator">+</span> <span class="token string">"&amp;userInfo=null"</span>             self<span class="token punctuation">.</span>_url <span class="token operator">=</span> url            <span class="token comment"># 保存参数至文本</span>            self<span class="token punctuation">.</span>_cfg<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"Param"</span><span class="token punctuation">,</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span> ret<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_cfg<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"Param"</span><span class="token punctuation">,</span> <span class="token string">"noncestr"</span><span class="token punctuation">,</span> ret<span class="token punctuation">[</span><span class="token string">"noncestr"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_cfg<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"Param"</span><span class="token punctuation">,</span> <span class="token string">"sign"</span><span class="token punctuation">,</span> ret<span class="token punctuation">[</span><span class="token string">"sign"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_cfg<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'param.ini'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"send request error...."</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果重启会导致参数失效，所以插件把变动的参数保存了下来，每次插件更新的时候将相关的参数更新进去，这样重启时间不长的话就不需要重新抓包了。</p><h3 id="4-HA配置"><a href="#4-HA配置" class="headerlink" title="4.HA配置"></a>4.HA配置</h3><hr><p>在配置文件中加上如下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">platform</span><span class="token punctuation">:</span> gjdw<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'电费'</span><span class="token key atrule">openid</span><span class="token punctuation">:</span> <span class="token string">'xxxxxxxxx-xxxxxxxxx'</span><span class="token key atrule">noncestr</span><span class="token punctuation">:</span> <span class="token string">'xxxxxxxxx'</span><span class="token key atrule">sign</span><span class="token punctuation">:</span> <span class="token string">'xxxxxxxxx'</span><span class="token key atrule">unionid</span><span class="token punctuation">:</span> <span class="token string">'xxxxxxxxx'</span><span class="token key atrule">timestamp</span><span class="token punctuation">:</span> <span class="token string">'xxxxxxxxx'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加  <strong>param.ini</strong> 配置文件，文件内容如下</p><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token selector">[Param]</span><span class="token constant">timestamp</span> <span class="token attr-value"><span class="token punctuation">=</span> xxxxxxxxx</span><span class="token constant">noncestr</span> <span class="token attr-value"><span class="token punctuation">=</span> xxxxxxxxx</span><span class="token constant">sign</span> <span class="token attr-value"><span class="token punctuation">=</span> xxxxxxxxx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-成果展示"><a href="#5-成果展示" class="headerlink" title="5.成果展示"></a>5.成果展示</h3><hr><p><img src="/img/20210406/dianfei.png" alt="插件展示"></p><h3 id="6-附件下载"><a href="#6-附件下载" class="headerlink" title="6.附件下载"></a>6.附件下载</h3><hr><p><a href="/download/%E7%94%B5%E8%B4%B9%E6%8F%92%E4%BB%B6.zip">点击下载</a> 插件</p><p>或者去论坛我发的 <a href="https://bbs.hassbian.com/thread-12037-1-1.html"><strong>电费插件-这次应该全国通用了吧</strong></a> 帖子下载。</p><h3 id="7-结语"><a href="#7-结语" class="headerlink" title="7.结语"></a>7.结语</h3><hr><p>自己写写插件还是挺好玩的，最近玩了玩Node-Red和MQTT，感觉这个搞插件还是快的。有几个写好的插件可以先看看，抓了美食杰和微博热搜的数据</p><p><img src="/img/20210406/info.png" alt="MQTT插件展示"></p>]]></content>
      
      
      <categories>
          
          <category> 智能家居 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HA </tag>
            
            <tag> python </tag>
            
            <tag> 插件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小长假游记</title>
      <link href="2021/04/05/jq-2021-qm/"/>
      <url>2021/04/05/jq-2021-qm/</url>
      
        <content type="html"><![CDATA[<h3 id="0-假期安排"><a href="#0-假期安排" class="headerlink" title="0.假期安排"></a>0.假期安排</h3><p>​    三天的小长假，回家祭祖顺便带小孩玩玩。</p><h3 id="1-第一天"><a href="#1-第一天" class="headerlink" title="1.第一天"></a>1.第一天</h3><p>​     早上早早起床，想着早点走路上不会堵车，奈何走的还是不够早，9:00了才出门。在出城的路上还是堵了一会的，上了高速后就好了很多了。回去之后已经中午了，去喝了个鸭汤就回去休息了。鸭汤没有之前的好喝了，门面也变小了。[ 图片网上找的，还是之前的店面 ]</p><p><img src="/img/20210405/jangmuya0.jpg" alt="老鸭汤的店"></p><p>下午彤妈约了闺蜜出去玩，我就和彤宝一起睡觉休息了。这一睡就到4点多了。起来弄弄之后，去接彤妈之后，顺便带彤彤见见她的阿姨们。接着晚上又是一个小饭局。</p><h3 id="2-第二天"><a href="#2-第二天" class="headerlink" title="2.第二天"></a>2.第二天</h3><p>​    今天是清明，怕路上堵，早点起床回老家祭祖。回家的路上还好，不是特别的堵。早早就到家了。到了老家小家伙就开始挖挖土了。</p><p><img src="/img/20210405/IMG_1567.jpg" alt="爱挖土宝宝0"><img src="/img/20210405/IMG_1568.jpg" alt="爱挖土宝宝1"></p><p>​    祭祖后休息了一下，约了小伙伴一起遛娃。去了一个之前一直想去但是没去的地方，天气和风景都不错。彤宝到了之后还是先挖土<span class="github-emoji"><span>😄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</p><p><img src="/img/20210405/IMG_1572.jpg" alt="爱挖土宝宝2"></p><p>之前小伙伴的宝宝在睡觉，没能一起参与，好在一会她就醒了，然后捡了个风筝，就一起玩了起来了。</p><p><img src="/img/20210405/yiqi.jpg" alt="一起放风筝"></p><h3 id="3-最后一天"><a href="#3-最后一天" class="headerlink" title="3.最后一天"></a>3.最后一天</h3><p>​    很快就要和小长假说拜拜了。最后一天要早点回南京，回去给他做点面包和饺子，这样平时可以吃吃。本来想着中午早点走回不堵的，事与愿违，依然堵。走的早些时间也充裕些。回家就开始干活了，一下是牛角包的成果图，还是可以的。饺子的图没拍。下次争取都图。</p><p><img src="/img/20210405/njb.jpg" alt="牛角包"></p><h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h3><p>   三天的小长假还算快乐，期待下次的游记。<span class="github-emoji"><span>😆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游玩 </tag>
            
            <tag> 遛娃 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HA南京水费插件</title>
      <link href="2021/04/02/njwater/"/>
      <url>2021/04/02/njwater/</url>
      
        <content type="html"><![CDATA[<h3 id="0-插件准备"><a href="#0-插件准备" class="headerlink" title="0.插件准备"></a>0.插件准备</h3><p>a) 登录<a href="http://www.jlwater.com/login.html">南京水务</a>的官网</p><p>b) 按住F12进入开发者模式</p><p>c) 拿到cookie和客户号</p><p>结果如图：</p><p><img src="/img/njwater/njwater01.png" alt="结果截图"></p><h3 id="1-配置HA"><a href="#1-配置HA" class="headerlink" title="1.配置HA"></a>1.配置HA</h3><p>将自定义插件上传到对应的目录下</p><p>custom_components<br>└─nanjing_water<br>        sensor.py<br>        __init__.py</p><p>接着在 configuration.yaml 中添加</p><p><strong>sensor:</strong></p><p>  <strong>- platform: nanjing_water</strong><br>     <strong>name: ‘水费’</strong><br>     <strong>custno: ‘XXXXX’</strong><br>     <strong>cookies: ‘XXXXXXXXXXXXXX’</strong></p><h3 id="2-重启HA"><a href="#2-重启HA" class="headerlink" title="2.重启HA"></a>2.重启HA</h3><h3 id="3-结果展示"><a href="#3-结果展示" class="headerlink" title="3.结果展示"></a>3.结果展示</h3><p><img src="/img/njwater/njwater02.png" alt="结果截图"></p><h3 id="4-代码展示"><a href="#4-代码展示" class="headerlink" title="4.代码展示"></a>4.代码展示</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""Support for nanjing water# Author: freefitter# Created: 2019-08-21"""</span><span class="token keyword">import</span> logging<span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>const <span class="token keyword">import</span> <span class="token punctuation">(</span>    CONF_API_KEY<span class="token punctuation">,</span> CONF_NAME<span class="token punctuation">,</span> ATTR_ATTRIBUTION<span class="token punctuation">,</span> CONF_ID    <span class="token punctuation">)</span><span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span>entity <span class="token keyword">import</span> Entity<span class="token keyword">import</span> homeassistant<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span>config_validation <span class="token keyword">as</span> cv<span class="token keyword">import</span> voluptuous <span class="token keyword">as</span> vol<span class="token keyword">from</span> homeassistant<span class="token punctuation">.</span>components<span class="token punctuation">.</span>sensor <span class="token keyword">import</span> PLATFORM_SCHEMA<span class="token keyword">import</span> requests<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup_Log<span class="token operator">=</span>logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>DEFAULT_NAME <span class="token operator">=</span> <span class="token string">'nanjing_water'</span>COOKIES <span class="token operator">=</span> <span class="token string">'cookies'</span>CUSTNO <span class="token operator">=</span> <span class="token string">'custno'</span>PLATFORM_SCHEMA <span class="token operator">=</span> PLATFORM_SCHEMA<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">{</span>    vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>COOKIES<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>    vol<span class="token punctuation">.</span>Required<span class="token punctuation">(</span>CUSTNO<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span>    vol<span class="token punctuation">.</span>Optional<span class="token punctuation">(</span>CONF_NAME<span class="token punctuation">,</span> default<span class="token operator">=</span> DEFAULT_NAME<span class="token punctuation">)</span><span class="token punctuation">:</span> cv<span class="token punctuation">.</span>string<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>HEADERS <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>    <span class="token string">'Upgrade-Insecure-Requests'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>    <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span><span class="token punctuation">,</span>    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (iPhone; CPU iPhone OS 12_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/WIFI Language/zh_CN'</span><span class="token punctuation">,</span>    <span class="token string">'Referer'</span><span class="token punctuation">:</span> <span class="token string">'http://www.jlwater.com/waterFee/waterWx'</span><span class="token punctuation">,</span>    <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span> <span class="token string">'zh-cn'</span><span class="token punctuation">,</span>    <span class="token string">'Accept-Encoding'</span><span class="token punctuation">:</span> <span class="token string">'gzip, deflate'</span><span class="token punctuation">}</span>API_URL <span class="token operator">=</span> <span class="token string">"http://www.jlwater.com/waterFee/detail"</span><span class="token keyword">def</span> <span class="token function">setup_platform</span><span class="token punctuation">(</span>hass<span class="token punctuation">,</span> config<span class="token punctuation">,</span> add_devices<span class="token punctuation">,</span> discovery_info<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    cookies <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>COOKIES<span class="token punctuation">)</span>    custno <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>CUSTNO<span class="token punctuation">)</span>    sensor_name <span class="token operator">=</span> config<span class="token punctuation">.</span>get<span class="token punctuation">(</span>CONF_NAME<span class="token punctuation">)</span>    query_dict <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'consNo'</span><span class="token punctuation">:</span> custno<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    HEADERS<span class="token punctuation">[</span><span class="token string">"Cookie"</span><span class="token punctuation">]</span> <span class="token operator">=</span> cookies    add_devices<span class="token punctuation">(</span><span class="token punctuation">[</span>NanjingWater<span class="token punctuation">(</span>sensor_name<span class="token punctuation">,</span>query_dict<span class="token punctuation">,</span>cookies<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">NanjingWater</span><span class="token punctuation">(</span>Entity<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Representation of a Nanjing water """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>sensor_name<span class="token punctuation">,</span>query_dict<span class="token punctuation">,</span>cookies<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>attributes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        self<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token boolean">None</span>        self<span class="token punctuation">.</span>_query_dict <span class="token operator">=</span> query_dict        self<span class="token punctuation">.</span>_name <span class="token operator">=</span> sensor_name        self<span class="token punctuation">.</span>_cookies <span class="token operator">=</span> cookies    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the name of the sensor."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_name    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the state of the sensor."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_state    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">icon</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""返回mdi图标."""</span>        <span class="token keyword">return</span> <span class="token string">'mdi:cup-water'</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">device_state_attributes</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the state attributes."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>attributes    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">unit_of_measurement</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Return the unit this state is expressed in."""</span>        <span class="token keyword">return</span> <span class="token string">"元"</span>    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>API_URL<span class="token punctuation">,</span>params<span class="token operator">=</span>self<span class="token punctuation">.</span>_query_dict<span class="token punctuation">,</span>headers <span class="token operator">=</span> HEADERS<span class="token punctuation">)</span>        <span class="token keyword">except</span> ReadTimeout<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Connection timeout...."</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> ConnectionError<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Connection Error...."</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> RequestException<span class="token punctuation">:</span>            _Log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Unknown Error"</span><span class="token punctuation">)</span>        <span class="token comment"># res = response.content.decode('utf-8')</span>        soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">,</span><span class="token string">'html.parser'</span><span class="token punctuation">)</span>        waterFee <span class="token operator">=</span> soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">"#searchFrom &gt; div:nth-child(2) &gt; div:nth-child(1)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'￥'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        lajiFee <span class="token operator">=</span> soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">"#searchFrom &gt; div:nth-child(2) &gt; div:nth-child(2)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'￥'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        weiyueFee <span class="token operator">=</span> soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">"#searchFrom &gt; div:nth-child(2) &gt; div:nth-child(3)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'￥'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        shangqijieyuFee <span class="token operator">=</span> soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">"#searchFrom &gt; div:nth-child(2) &gt; div:nth-child(4)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'￥'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        qianfeiFee <span class="token operator">=</span> soup<span class="token punctuation">.</span>select_one<span class="token punctuation">(</span><span class="token string">"#searchFrom &gt; div:nth-child(2) &gt; div:nth-child(2)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'￥'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token comment">#_Log.info("waterFee=" + waterFee)</span>        self<span class="token punctuation">.</span>_state <span class="token operator">=</span> waterFee        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'lajiFee'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lajiFee        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'weiyueFee'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weiyueFee        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'shangqijieyuFee'</span><span class="token punctuation">]</span> <span class="token operator">=</span> shangqijieyuFee        self<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'qianfeiFee'</span><span class="token punctuation">]</span> <span class="token operator">=</span> qianfeiFee<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-附件下载"><a href="#5-附件下载" class="headerlink" title="5. 附件下载"></a>5. 附件下载</h3><p>附件可以去论坛上下载 <a href="https://bbs.hassbian.com/thread-11955-1-1.html">南京水费插件</a></p>]]></content>
      
      
      <categories>
          
          <category> 智能家居 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HA </tag>
            
            <tag> python </tag>
            
            <tag> 插件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>少儿编程之Scratch</title>
      <link href="2020/07/06/scratch/"/>
      <url>2020/07/06/scratch/</url>
      
        <content type="html"><![CDATA[<h3 id="0-Scratch安装体验"><a href="#0-Scratch安装体验" class="headerlink" title="0.Scratch安装体验"></a>0.<strong>Scratch</strong>安装体验</h3><p>少儿编程软件<strong>Scratch</strong>是美国麻省理工提供的一款软件，Scratch3.0可以更好的支持外部硬件模块，并且能够与Makey,micro,We Do 2.0机器人，乐高 EV3机器人交互。</p><h3 id="1-软件下载"><a href="#1-软件下载" class="headerlink" title="1.软件下载"></a>1.软件下载</h3><p>从<a href="https://scratch.mit.edu/download">Scratch官网下载</a>，当然你也可以先从<a href="https://scratch.mit.edu/projects/editor/?tutorial=getStarted">这个地址</a>开始尝试。下载的页面和尝试的页面如下：</p><p><img src="/img/scratchdownload.png" alt="scratch下载"></p><p><img src="/img/scratchinfo.png" alt="scratch信息"></p><p>安装后的界面如下：</p><p><img src="/img/scratchdesktop.png" alt="scratch软件界面"></p><p>和网页版的基本没差。</p><h3 id="2-开始HelloWord"><a href="#2-开始HelloWord" class="headerlink" title="2.开始HelloWord"></a>2.开始HelloWord</h3><p>第一个小玩意：</p><p>代码：</p><p><img src="/img/helloworld.png" alt="helloworld图"></p><p>效果：</p><p><img src="/img/helloworld.gif" alt="helloworld"></p><h3 id="3-后续想法"><a href="#3-后续想法" class="headerlink" title="3.后续想法"></a>3.后续想法</h3><p>结合硬件做一些东西</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Scratch </tag>
            
            <tag> 编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>智能家居体验与感受</title>
      <link href="2020/06/17/smartHome/"/>
      <url>2020/06/17/smartHome/</url>
      
        <content type="html"><![CDATA[<h2 id="0-入坑原因："><a href="#0-入坑原因：" class="headerlink" title="0.入坑原因："></a>0.入坑原因：</h2><p>​        家里装修完了，然后想自己搞点不一样的东西，能够让自己偷偷懒，还能够方便家里人使用。一开始啥也不知道，也不知道选择啥。也没有想到自己的做，想着用成熟的东西搭建自己的智能家居。正好家附近有个小米之家，去看了看。然后就入手了<a href="https://www.mi.com/buy/detail?product_id=5708&amp;cfrom=search">米家智能套装</a>，是最早一批的智能的东西。<img src="/img/mihome.jpg" alt="米家智能套装"></p><p>从这开始便开始了智能家居之旅。紧接着又入手了很多的智能设备和智能开关。现在的设备已经达到80个之多。</p><h2 id="1-米家APP体验"><a href="#1-米家APP体验" class="headerlink" title="1.米家APP体验"></a>1.米家APP体验</h2><p>​      有了这些智能设备之后，如果要让它们能够联合起来做一些事情，你得自己编写一个智能，条件可以是你现在的传感器或者他自己提供的一些东西，操作的设备只能是你的智能设备或者你的手机了，米家App基本上能够满足大部分人的需求了，但是有些像设置更细节的东西，他就爱莫能助了。</p><h2 id="2-入坑HomeAssistant"><a href="#2-入坑HomeAssistant" class="headerlink" title="2.入坑HomeAssistant"></a>2.入坑HomeAssistant</h2><p>​     有了这些硬件设备，但是又不甘于被米家App束缚，所以就开始找有没有别的啥能够支持这些智能硬件，找着找着找到HA，这个东西还是很强大的。可以自己编写传感器，可定制化程度非常高，能够完成很多米家App不能完成的事情。可以去<a href="https://bbs.hassbian.com/">瀚思彼岸</a> 论坛学习各个神的操作。</p><h2 id="3-如今的智能设备"><a href="#3-如今的智能设备" class="headerlink" title="3.如今的智能设备"></a>3.如今的智能设备</h2><p>​     现在家里的智能设备已经80多个了，很多已经接入了HA，但是还有少数设备没有接入其中。后面陆陆续续的接入到当中去。因为一开始没有买小米全家桶，所以很多的都是使用智能开关来控制设备的，所以家中的智能插座和智能开关比较多。</p><h2 id="4-后话"><a href="#4-后话" class="headerlink" title="4. 后话"></a>4. 后话</h2><p>​     智能家居还是要从开始进行规划，等自己以后有能力在买一套的时候，一定要彻头彻尾的搞一次真正的智能家居</p>]]></content>
      
      
      <categories>
          
          <category> 智能家居 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 智能家居 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo博客搭建</title>
      <link href="2020/06/08/startPage/"/>
      <url>2020/06/08/startPage/</url>
      
        <content type="html"><![CDATA[<h2 id="搭建Hexo"><a href="#搭建Hexo" class="headerlink" title="搭建Hexo"></a>搭建Hexo</h2><p>之前自己搭建<a href="http://freefitter.com:1200/">wordpress</a>的博客，网上搜索下，还有人推荐Hexo的，然后就尝试着自己搞了个玩玩，发现并不复杂<br>参照了<a href="https://www.jianshu.com/p/4818be9093f5">这个教程</a>还有<a href="https://hexo.fluid-dev.com/docs/">官方的文档</a>。三下五除二干了起来。</p><h2 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h2><p>   搭建完成就是这样啦! <img src="/img/pre.png" alt="成果展示"> 赶脚还行。</p><h2 id="说在最后"><a href="#说在最后" class="headerlink" title="说在最后"></a>说在最后</h2><p>   自己瞎折腾，没事整点事</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
